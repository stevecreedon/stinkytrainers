<p><a id='top'></a></p>

<h1>7. The Game Model</h1>

<p>As you can see from the diagram Game has a <code>has\_and\_belongs\_to\_many</code> relationship with User and we&#39;ve added another class, External Player. We want our users to be able to invite anyone to a game not just other StinkTrainers users. We could just add a list of email address to a game that represent the external players but then our application would have to cope with a player that&#39;s either a User object or a string and that may make our code a little hard to handle. So we&#39;re going to add the model External Player, effectively a user that hasn&#39;t signed-up. Our game can then have a polymorphic collection called players that are both Users and External players. As long as User and ExternalPLayer have similar interfaces then we should be able to keep the code nice and easy.</p>

<p>We&#39;re going to get more TDD and write tests for the Game model and the ExternalPLayer model first then make them pass.</p>

<ol>
<li><a href="#tests-for-the-game-model">Tests for the Game Model</a></li>
<li><a href="#tests-for-the-externalplayer-model">Tests for the ExternalPlayer model</a></li>
<li><a href="#generate-the-game-and-externalplayer-models">Generate the Game and ExternalPlayer models</a></li>
<li><a href="#get-the-game-model-location-test-passing">Get the Game model #location test passing</a></li>
<li><a href="#get-the-game-model-at-test-passing">Get the Game model #at test passing</a></li>
<li><a href="#get-the-game-model-test-for-ordering-players-by-email-passing">Get the Game model test for ordering players by email passing</a></li>
<li><a href="#get-the-game-model-test-for-ordering-external-players-by-email-passing">Get the Game model test for ordering external_players by email passing</a></li>
<li><a href="#get-game-model-tests-for-the-over-helper-method-passing">Get Game model tests for the over? helper method passing</a></li>
<li><a href="#get-the-externalplayer-model-test-for-email-passing">Get the ExternalPlayer model test for email passing</a></li>
<li><a href="#get-the-externalplayer-email-must-be-unique-test-passing">Get the ExternalPlayer email must be unique test passing</a></li>
</ol>

<h2><a id='tests-for-the-game-model'></a> 7.1. Tests for the Game Model</h2>

<h3>7.1.1. First Draft</h3>

<p>First I&#39;ll write down some empty pending test before I start thinking about code.</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should not be valid if the game has no location&#39;</span>

<span class="n">it</span> <span class="s1">&#39;should not be valid if the game has no date&#39;</span>

<span class="n">it</span> <span class="s1">&#39;should not be valid if the game has no players&#39;</span>

<span class="n">it</span> <span class="s1">&#39;should return a list of external players ordered by email&#39;</span>

<span class="n">it</span> <span class="s1">&#39;should return a list of players ordered by email&#39;</span>

<span class="n">it</span> <span class="s1">&#39;should return true if the game is in the past&#39;</span>

<span class="n">it</span> <span class="s1">&#39;should return false if the game is not in the past&#39;</span>
</pre></div>

<h3>7.1.2. Now Code the tests</h3>

<p>Create the file spec/models/game_spec.rb and code the tests.</p>
<div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Game</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s1">&#39;should not be valid if the game has no location&#39;</span> <span class="k">do</span>
      <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:location</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="n">game</span><span class="o">.</span><span class="n">valid?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
      <span class="n">game</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;Location can&#39;t be blank&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">&#39;should not be valid if the game has no date&#39;</span> <span class="k">do</span>
      <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:at</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="n">game</span><span class="o">.</span><span class="n">valid?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
      <span class="n">game</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;At can&#39;t be blank&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">&#39;should return a list of players ordered by email&#39;</span> <span class="k">do</span>
      <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">)</span>

      <span class="n">andrew</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;andrew@textxyz.com&#39;</span><span class="p">)</span>
      <span class="n">zoe</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;zoe@textxyz.com&#39;</span><span class="p">)</span>
      <span class="n">mark</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;mark@textxyz.com&#39;</span><span class="p">)</span>

      <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">andrew</span>
      <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">zoe</span>
      <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">mark</span>

      <span class="n">game</span><span class="o">.</span><span class="n">players</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">andrew</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="n">zoe</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">&#39;should return a list of external players ordered by email&#39;</span> <span class="k">do</span>
      <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">)</span>

      <span class="n">andrew</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;andrew@textxyz.com&#39;</span><span class="p">)</span>
      <span class="n">zoe</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;zoe@textxyz.com&#39;</span><span class="p">)</span>
      <span class="n">mark</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;mark@textxyz.com&#39;</span><span class="p">)</span>

      <span class="n">game</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">andrew</span>
      <span class="n">game</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">zoe</span>
      <span class="n">game</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">mark</span>

      <span class="n">game</span><span class="o">.</span><span class="n">external_players</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">andrew</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="n">zoe</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">&#39;should return true if the game is in the past&#39;</span> <span class="k">do</span>
      <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:at</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span>
      <span class="n">game</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">over?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">&#39;should return false if the game is not in the past&#39;</span> <span class="k">do</span>
      <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:at</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
      <span class="n">game</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">over?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
    <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>NOTE: If your wondering why we use Game.new to create a game but FactoryGirl for user and external_player it&#39;s because we&#39;re testing the game class so it feels wrong to use a mocked FactoryGirl object even though it theoretically is almost the same thing.</p>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/7-create-the-game-model.html#tests-for-the-game-model"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='tests-for-the-externalplayer-model'></a> 7.2. Tests for the ExternalPlayer model</h2>

<h3>7.2.1. First Draft</h3>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should not be valid if the player has no email&#39;</span>

<span class="n">it</span> <span class="s1">&#39;should not be valid if the email already exists&#39;</span>
</pre></div>

<h3>7.2.2. Now Code</h3>

<h3>7.2.3. Now write some code</h3>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should not be valid if the player has no email&#39;</span> <span class="k">do</span>
  <span class="n">external_player</span> <span class="o">=</span> <span class="no">ExternalPlayer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">external_player</span><span class="o">.</span><span class="n">valid?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
  <span class="n">external_player</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;Email can&#39;t be blank&quot;</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">it</span> <span class="s1">&#39;should not be valid if the email already exists&#39;</span> <span class="k">do</span>
  <span class="no">ExternalPlayer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;bolt@lighting.co.uk&#39;</span><span class="p">)</span>

  <span class="n">external_player</span> <span class="o">=</span> <span class="no">ExternalPlayer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;bolt@lighting.co.uk&#39;</span><span class="p">)</span>
  <span class="n">external_player</span><span class="o">.</span><span class="n">valid?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
  <span class="n">external_player</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;Email has already been taken&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>We&#39;ve coded our test but we haven&#39;t yet created the User or ExternalPlayer model (how TDD is that ?) so if we try running </p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p>we will get a lot of horrible errors as the Game and ExternalPlayers don&#39;t yet exist.</p>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/7-create-the-game-model.html#tests-for-the-externalplayer-model"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='generate-the-game-and-externalplayer-models'></a> 7.3. Generate the Game and ExternalPlayer models</h2>

<p>We&#39;ll generate both models so that we can start running tests.</p>

<p>NOTE: We&#39;ve already written specs for game and external_player so the generator will stop part of the way and warn us of a conflict because the files <code>spec/models/game_spec.rb</code> and <code>spec/models/external_player_spec.rb</code> already exist.</p>
<div class="highlight"><pre><span class="go">invoke  active_record</span>
<span class="go">   create    db/migrate/20120909094450_create_games.rb</span>
<span class="go">   create    app/models/game.rb</span>
<span class="go">   invoke    rspec</span>
<span class="go"> conflict      spec/models/game_spec.rb</span>
<span class="go"> Overwrite /Users/stephencreedon/devel/stinkytrainers/spec/models/game_spec.rb? (enter &quot;h&quot; for help) [Ynaqdh] n</span>
</pre></div>

<p>Just return &#39;n&#39; (for no) when the generator asks if you want to overwrite the existing file. </p>
<div class="highlight"><pre><span class="go">bundle exec rails g model game location:string at:datetime</span>
<span class="go">bundle exec rails g model external_player email:string </span>
</pre></div>

<p>Now we have a Game and ExternalPlayer model try running the tests again</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p>Rails will object because it&#39;s detected that we have migrations for Game and ExternalPlayer that we haven&#39;t run yet</p>
<div class="highlight"><pre><span class="go">You have 2 pending migrations:</span>
<span class="go">  20120909094450 CreateGames</span>
<span class="go">  20120909094851 CreateExternalPlayers</span>
<span class="go">Run `rake db:migrate` to update your database then try again.</span>
</pre></div>

<p>Take a quick look at the migrations in db/migrate</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateGames</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:games</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:location</span>
      <span class="n">t</span><span class="o">.</span><span class="n">datetime</span> <span class="ss">:at</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateExternalPlayers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:external_players</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>So run the migrations:</p>
<div class="highlight"><pre><span class="go">bundle exec rake db:migrate</span>
</pre></div>

<p>which should give us</p>
<div class="highlight"><pre><span class="go">==  CreateGames: migrating ====================================================</span>
<span class="go">-- create_table(:games)</span>
<span class="go">   -&gt; 0.0701s</span>
<span class="go">==  CreateGames: migrated (0.0702s) ===========================================</span>

<span class="go">==  CreateExternalPlayers: migrating ==========================================</span>
<span class="go">-- create_table(:external_players)</span>
<span class="go">   -&gt; 0.0014s</span>
<span class="go">==  CreateExternalPlayers: migrated (0.0015s) =================================</span>
</pre></div>

<p>We now have the Game and ExternalPlayer models in our code and the games and external_players tables in the database so we should be able to run the tests.</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p>The tests will now run but, of course, we should now have 8 failing because we haven&#39;t put any code into them yet.</p>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/7-create-the-game-model.html#generate-the-game-and-externalplayer-models"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='get-the-game-model-location-test-passing'></a> 7.4. Get the Game model #location test passing</h2>

<p>The first test requires that we have a location</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should not be valid if the game has no location&#39;</span> <span class="k">do</span>
  <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:location</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">game</span><span class="o">.</span><span class="n">valid?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
  <span class="n">game</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;Location can&#39;t be blank&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>Let&#39;s use an ActiveModel validation for this:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Game</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:location</span>

  <span class="n">validates</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>

<p>run the tests</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p>and you should find we only have 7 failing tests.</p>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/7-create-the-game-model.html#get-the-game-model-location-test-passing"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='get-the-game-model-at-test-passing'></a> 7.5. Get the Game model #at test passing</h2>

<p>Our second test requires that we have a date</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should not be valid if the game has no date&#39;</span> <span class="k">do</span>
  <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:at</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">game</span><span class="o">.</span><span class="n">valid?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
  <span class="n">game</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;Date can&#39;t be blank&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>Again, we&#39;ll use an ActiveModel validation for this:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Game</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:location</span>

  <span class="n">validates</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>

<p>Run the tests and we should be down to 6 failures</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/7-create-the-game-model.html#get-the-game-model-at-test-passing"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='get-the-game-model-test-for-ordering-players-by-email-passing'></a> 7.6. Get the Game model test for ordering players by email passing</h2>

<p>For this one we need to add the association between games and players. Now players are actually users but it seems a little odd that a game has a collection of users so we&#39;ll create an association called players, tell it to use User and also tell it to order users by email.</p>

<p>This is the test we have to make work
~~~ruby
it &#39;should return a list of players ordered by email&#39; do
  game = FactoryGirl.create(:game)</p>

<p>andrew = FactoryGirl.create(:user, :email =&gt; &#39;andrew@textxyz.com&#39;)
  zoe = FactoryGirl.create(:user, :email =&gt; &#39;zoe@textxyz.com&#39;)
  mark = FactoryGirl.create(:user, :email =&gt; &#39;mark@textxyz.com&#39;)</p>

<p>game.players &lt;&lt; andrew
  game.players &lt;&lt; zoe
  game.players &lt;&lt; mark</p>

<p>game.players.should == [andrew, mark, zoe]
end
~~~</p>

<p>NOTE: we&#39;ve broken the rule about not using FactoryGirl to create the objects we&#39;re testing. In this case it&#39;s not so bad because we&#39;re actually not testing Game but the association players. We&#39;ve used FactoryGirl because we needed a valid instance of Game before we can add records to an association. Remember that our games<em>users join table needs a game</em>id ? Well if we&#39;d just created Game.new the record isn&#39;t saved, if it isn&#39;t saved it won&#39;t have an id. For the association to work we need a saved, and thus valid instance of game, hence we use FactoryGirl. We could have created a valid game in the test <code>Game.create(:location =&gt; &#39;xyz&#39;, :at =&gt; Time.now)</code> but that would mean every time we add a new validation to Game we&#39;d have to rewrite this line in our tests.</p>

<p>let&#39;s create the has_and_belongs_to_many players association in our game. Note that we have to explicitly tell it that our players collection is actually a user.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Game</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:location</span>

  <span class="n">validates</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:players</span><span class="p">,</span> <span class="ss">:class_name_</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span>
<span class="k">end</span>
</pre></div>

<p>We also need the has_and_belongs_to_many relationship that connects our user to games. This time we don&#39;t need to do any renaming as user.games makes a little more sense</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Include default devise modules. Others available are:</span>
  <span class="c1"># :token_authenticatable, :confirmable,</span>
  <span class="c1"># :lockable, :timeoutable and :omniauthable</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span>

  <span class="c1"># Setup accessible (or protected) attributes for your model</span>
  <span class="n">attr_accessible</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">:remember_me</span>
  <span class="c1"># attr_accessible :title, :body</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:sports</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:games</span>
<span class="k">end</span>
</pre></div>

<p>We&#39;ve associated game to user and user to game. Since this is a has_and_belongs_to_many we need to create a join table</p>
<div class="highlight"><pre><span class="go">bundle exec rails g migration CreateGamesUsersJoinTable</span>
</pre></div>

<p>Open the migration in db/migrate. When we created the sports_users join table we created a more traditional migration that used <code>def up</code> and <code>def down</code> to handle migrations and rollbacks. This time we&#39;ll use the more succinct <code>def change</code></p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateGamesUsersJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>

  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:games_users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:user_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:game_id</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:games_users</span><span class="p">,</span> <span class="ss">:user_id</span>
    <span class="n">add_index</span> <span class="ss">:games_users</span><span class="p">,</span> <span class="ss">:game_id</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>NOTE that we&#39;ve used user_id not player_id but because we&#39;ve specified the class<em>name as &#39;User&#39; in our association `:class</em>name =&gt; &#39;User&#39; our game class will look for a user<em>id in the join table games</em>users when we call players.</p>

<p>run the migration</p>
<div class="highlight"><pre><span class="go">bundle exec rake db:migrate</span>
</pre></div>

<p>and we should be ready to see if our test passes.</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p>We still have 7 tests failing and the one we&#39;re interested will be giving us quite a lengthy output</p>
<div class="highlight"><pre><span class="go">4) Game should return a list of players ordered by email</span>
<span class="go">    Failure/Error: game.players.should == [andrew, mark, zoe]</span>
<span class="go">      expected: [#&lt;User id: 1, email: &quot;andrew@textxyz.com&quot;, encrypted_password: &quot;$2a$04$jY7YZG2818JmzoMGEM7GAeEzUfSlcq2GtYkZhOTXZZV5...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 0, current_sign_in_at: nil, last_sign_in_at: nil, current_sign_in_ip: nil, last_sign_in_ip: nil, created_at: &quot;2012-09-09 16:10:51&quot;, updated_at: &quot;2012-09-09 16:10:51&quot;&gt;, #&lt;User id: 3, email: &quot;mark@textxyz.com&quot;, encrypted_password: &quot;$2a$04$xBvXRHoFcRRbjPXVlDb0FunAT.SUTfqldMwhn0M31J7B...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 0, current_sign_in_at: nil, last_sign_in_at: nil, current_sign_in_ip: nil, last_sign_in_ip: nil, created_at: &quot;2012-09-09 16:10:51&quot;, updated_at: &quot;2012-09-09 16:10:51&quot;&gt;, #&lt;User id: 2, email: &quot;zoe@textxyz.com&quot;, encrypted_password: &quot;$2a$04$6UFM8tc755xJ7J8d853EyeqFa6bDUdtm6CY0awqXrrsf...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 0, current_sign_in_at: nil, last_sign_in_at: nil, current_sign_in_ip: nil, last_sign_in_ip: nil, created_at: &quot;2012-09-09 16:10:51&quot;, updated_at: &quot;2012-09-09 16:10:51&quot;&gt;]</span>
<span class="go">           got: [#&lt;User id: 1, email: &quot;andrew@textxyz.com&quot;, encrypted_password: &quot;$2a$04$jY7YZG2818JmzoMGEM7GAeEzUfSlcq2GtYkZhOTXZZV5...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 0, current_sign_in_at: nil, last_sign_in_at: nil, current_sign_in_ip: nil, last_sign_in_ip: nil, created_at: &quot;2012-09-09 16:10:51&quot;, updated_at: &quot;2012-09-09 16:10:51&quot;&gt;, #&lt;User id: 2, email: &quot;zoe@textxyz.com&quot;, encrypted_password: &quot;$2a$04$6UFM8tc755xJ7J8d853EyeqFa6bDUdtm6CY0awqXrrsf...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 0, current_sign_in_at: nil, last_sign_in_at: nil, current_sign_in_ip: nil, last_sign_in_ip: nil, created_at: &quot;2012-09-09 16:10:51&quot;, updated_at: &quot;2012-09-09 16:10:51&quot;&gt;, #&lt;User id: 3, email: &quot;mark@textxyz.com&quot;, encrypted_password: &quot;$2a$04$xBvXRHoFcRRbjPXVlDb0FunAT.SUTfqldMwhn0M31J7B...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 0, current_sign_in_at: nil, last_sign_in_at: nil, current_sign_in_ip: nil, last_sign_in_ip: nil, created_at: &quot;2012-09-09 16:10:51&quot;, updated_at: &quot;2012-09-09 16:10:51&quot;&gt;] (using ==)</span>
<span class="go">      Diff:</span>
<span class="go">      @@ -1,4 +1,4 @@</span>
<span class="go">       [#&lt;User id: 1, email: &quot;andrew@textxyz.com&quot;, encrypted_password: &quot;$2a$04$jY7YZG2818JmzoMGEM7GAeEzUfSlcq2GtYkZhOTXZZV5...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 0, current_sign_in_at: nil, last_sign_in_at: nil, current_sign_in_ip: nil, last_sign_in_ip: nil, created_at: &quot;2012-09-09 16:10:51&quot;, updated_at: &quot;2012-09-09 16:10:51&quot;&gt;,</span>
<span class="go">      - #&lt;User id: 3, email: &quot;mark@textxyz.com&quot;, encrypted_password: &quot;$2a$04$xBvXRHoFcRRbjPXVlDb0FunAT.SUTfqldMwhn0M31J7B...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 0, current_sign_in_at: nil, last_sign_in_at: nil, current_sign_in_ip: nil, last_sign_in_ip: nil, created_at: &quot;2012-09-09 16:10:51&quot;, updated_at: &quot;2012-09-09 16:10:51&quot;&gt;,</span>
<span class="go">      - #&lt;User id: 2, email: &quot;zoe@textxyz.com&quot;, encrypted_password: &quot;$2a$04$6UFM8tc755xJ7J8d853EyeqFa6bDUdtm6CY0awqXrrsf...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 0, current_sign_in_at: nil, last_sign_in_at: nil, current_sign_in_ip: nil, last_sign_in_ip: nil, created_at: &quot;2012-09-09 16:10:51&quot;, updated_at: &quot;2012-09-09 16:10:51&quot;&gt;]</span>
<span class="go">      + #&lt;User id: 2, email: &quot;zoe@textxyz.com&quot;, encrypted_password: &quot;$2a$04$6UFM8tc755xJ7J8d853EyeqFa6bDUdtm6CY0awqXrrsf...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 0, current_sign_in_at: nil, last_sign_in_at: nil, current_sign_in_ip: nil, last_sign_in_ip: nil, created_at: &quot;2012-09-09 16:10:51&quot;, updated_at: &quot;2012-09-09 16:10:51&quot;&gt;,</span>
<span class="go">      + #&lt;User id: 3, email: &quot;mark@textxyz.com&quot;, encrypted_password: &quot;$2a$04$xBvXRHoFcRRbjPXVlDb0FunAT.SUTfqldMwhn0M31J7B...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 0, current_sign_in_at: nil, last_sign_in_at: nil, current_sign_in_ip: nil, last_sign_in_ip: nil, created_at: &quot;2012-09-09 16:10:51&quot;, updated_at: &quot;2012-09-09 16:10:51&quot;&gt;]</span>
</pre></div>

<p>Our association is working but we haven&#39;t told it to order by email yet. If you read it carefully it&#39;s telling us it expected andrew, mark, zoe but got andrew, zoe, mark.</p>

<p>The Diff is the difference between the two arrays.</p>

<p>Let&#39;s add ordering by email and get this test passing</p>

<p>run the tests and you should now have just 5 tests failing</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/7-create-the-game-model.html#get-the-game-model-test-for-ordering-players-by-email-passing"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='get-the-game-model-test-for-ordering-external-players-by-email-passing'></a> 7.7. Get the Game model test for ordering external_players by email passing</h2>

<p>This is a very similar problem to the previous one so we won&#39;t spend too much time on this.</p>

<p>Create the association in Game. Note that our external_players association is the same name as our class so we don&#39;t specify the :class_name</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Game</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:location</span>

  <span class="n">validates</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:players</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;users.email ASC&quot;</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:external_players</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;external_players.email ASC&quot;</span>
<span class="k">end</span>
</pre></div>

<p>Create the association in ExternalPlayer. Note that we don&#39;t need external_player.games to be in any particular order.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">ExternalPlayer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:email</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:games</span>
<span class="k">end</span>
</pre></div>

<p>Create the migration for the join table</p>
<div class="highlight"><pre><span class="go">bundle exec rails g migration CreateExternalPlayersGamesJoinTable</span>
</pre></div>

<p>Add this code to the migration</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateExternalPlayersGamesJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>

  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:external_players_games</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:external_player_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:game_id</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:external_players_games</span><span class="p">,</span> <span class="ss">:external_player_id</span>
    <span class="n">add_index</span> <span class="ss">:external_players_games</span><span class="p">,</span> <span class="ss">:game_id</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>run the migration</p>
<div class="highlight"><pre><span class="go">bundle exec rake db:migrate</span>
</pre></div>

<p>now run the tests and we should be down to 4 tests passing</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/7-create-the-game-model.html#get-the-game-model-test-for-ordering-external-players-by-email-passing"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='get-game-model-tests-for-the-over-helper-method-passing'></a> 7.8. Get Game model tests for the over? helper method passing</h2>

<p>We want to have a simple helper method <code>.over?</code> that tells us whether the game is in the past or not. methods ending in <code>?</code> such as <code>valid?</code>, <code>over?</code>, <code>nil?</code> &amp; <code>blank?</code> are a common ruby idiom where the method returns true or false.</p>

<p>This are the two tests we want to pass</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should return true if the game is in the past&#39;</span> <span class="k">do</span>
  <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:at</span> <span class="o">=&gt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">game</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">over?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
<span class="k">end</span>

<span class="n">it</span> <span class="s1">&#39;should return false if the game is not in the past&#39;</span> <span class="k">do</span>
  <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:at</span> <span class="o">=&gt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">game</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">over?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
<span class="k">end</span>
</pre></div>

<p>Add the <code>.over?</code> method to our game model</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Game</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:location</span>

  <span class="n">validates</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:players</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;users.email ASC&quot;</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:external_players</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;external_players.email ASC&quot;</span>

  <span class="k">def</span> <span class="nf">over?</span>
    <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">at</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>run the tests and we should be down to 2 failing tests</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/7-create-the-game-model.html#get-game-model-tests-for-the-over-helper-method-passing"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='get-the-externalplayer-model-test-for-email-passing'></a> 7.9. Get the ExternalPlayer model test for email passing</h2>

<p>This is very similar to the test for name in our sports model. We&#39;ll use an ActiveModel validation to make sure that the email is present</p>

<p>We want this test to pass</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should not be valid if the player has no email&#39;</span> <span class="k">do</span>
  <span class="n">external_player</span> <span class="o">=</span> <span class="no">ExternalPlayer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">external_player</span><span class="o">.</span><span class="n">valid?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
  <span class="n">external_player</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;Email can&#39;t be blank&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>add this validation</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">ExternalPlayer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:games</span>
<span class="k">end</span>
</pre></div>

<p>run the tests and we should be down to 1 failing test</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/7-create-the-game-model.html#get-the-externalplayer-model-test-for-email-passing"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='get-the-externalplayer-email-must-be-unique-test-passing'></a> 7.10. Get the ExternalPlayer email must be unique test passing</h2>

<p>This is very similar to the test for uniqueness of name in our sports model. We&#39;ll use an ActiveModel validation to make sure that the email doesn&#39;t already exist.</p>

<p>This is the test we want to pass. Note that we create a an ExternalPlayer in the first line then attempt to create another</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should not be valid if the email already exists&#39;</span> <span class="k">do</span>
  <span class="no">ExternalPlayer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;bolt@lighting.co.uk&#39;</span><span class="p">)</span>

  <span class="n">external_player</span> <span class="o">=</span> <span class="no">ExternalPlayer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;bolt@lighting.co.uk&#39;</span><span class="p">)</span>
  <span class="n">external_player</span><span class="o">.</span><span class="n">valid?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
  <span class="n">external_player</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;Email already taken&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>Add the email uniqueness validation to ExternalPlayer</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">ExternalPlayer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:uniqueness</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:games</span>
<span class="k">end</span>
</pre></div>

<p>run the tests and everything should be passing</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>
