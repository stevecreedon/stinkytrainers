<p><a id='top'></a></p>

<h1>4. Secure the dashboard</h1>

<p>To secure the dashboard we&#39;re going to need a user so that we are able to sign-up, store some password details, sign-out and then sign-in.</p>

<ol>
<li><a href="#add-the-devise-gem">Add the Devise gem</a></li>
<li><a href="#use-devise-to-create-the-user-model">Use Devise to create the User Model</a></li>
<li><a href="#secure-the-dashboard-with-devise">Secure the Dashboard with Devise</a></li>
<li><a href="#testing-the-dashboard-is-locked-down">Testing the Dashboard is locked down</a></li>
<li><a href="#test-signed-in-users-can-see-the-dashboard">Test signed-in users can see the Dashboard</a></li>
<li><a href="#testing-we-can-sign-in-and-see-the-dashboard">Testing we can sign-in and see the Dashboard  </a></li>
<li><a href="#testing-we-can-sign-up-and-see-the-dashboard">Testing we can sign-up and see the Dashboard </a></li>
</ol>

<h2><a id='add-the-devise-gem'></a> 4.1. Add the Devise gem</h2>

<p>Devise gives us authentication out-of-the-box. We&#39;ll be getting devise to build us an authenticating user class
and the views to allow users to sign up, sign-in and handle forgotten passwords.</p>

<h3>4.1.1. Add the devise gem to bundlers Gemfile</h3>

<p>Add the line <code>gem &#39;devise&#39;</code> to our Gemfile</p>
<div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.8&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;pg&#39;</span>

 <span class="c1"># Bundle edge Rails instead:</span>
 <span class="c1"># gem &#39;rails&#39;, :git =&gt; &#39;git://github.com/rails/rails.git&#39;</span>


<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;redcarpet&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;pygmentize&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;nokogiri&#39;</span>
<span class="k">end</span>



 <span class="c1"># Gems used only for assets and not required</span>
 <span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;~&gt; 3.2.3&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.2.1&#39;</span>

  <span class="c1"># See https://github.com/sstephenson/execjs#readme for more supported runtimes</span>
  <span class="c1"># gem &#39;therubyracer&#39;, :platforms =&gt; :ruby</span>

  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.0.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s2">&quot;twitter-bootstrap-rails&quot;</span><span class="p">,</span><span class="s1">&#39;~&gt; 2.0.7&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 2.0.2&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;devise&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 2.1.2&#39;</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;=2.11.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;=1.1.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;launchy&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span>
<span class="k">end</span>

 <span class="c1"># To use ActiveModel has_secure_password</span>
 <span class="c1"># gem &#39;bcrypt-ruby&#39;, &#39;~&gt; 3.0.0&#39;</span>

 <span class="c1"># To use Jbuilder templates for JSON</span>
 <span class="c1"># gem &#39;jbuilder&#39;</span>

 <span class="c1"># Use unicorn as the app server</span>
 <span class="c1"># gem &#39;unicorn&#39;</span>

 <span class="c1"># Deploy with Capistrano</span>
 <span class="c1"># gem &#39;capistrano&#39;</span>

 <span class="c1"># To use debugger</span>
 <span class="c1"># gem &#39;debugger&#39;</span>
</pre></div>

<h3>4.1.2. Install the devise gem</h3>
<div class="highlight"><pre><span class="go">bundle install</span>
</pre></div>

<h3>4.1.3. Add devise to our application</h3>

<p>Most gems are libraries of code that our application will use as it&#39;s running. Some, like Devise, need to bind themselves to Rails as they load so that they can enhance or change existing functionality. Rails does this with initializers and we need to install Devise so that it will install it&#39;s initializer in the appropriate place in our Rails App.</p>

<p>Run the installer</p>
<div class="highlight"><pre><span class="go">rails generate devise:install</span>
</pre></div>

<p>Don&#39;t worry if Devise prints all this stuff below to console, it&#39;s just giving you some helpful advise about what to do next.</p>
<div class="highlight"><pre><span class="go">Some setup you must do manually if you haven&#39;t yet:</span>

<span class="go">   1. Ensure you have defined default url options in your environments files. Here </span>
<span class="go">      is an example of default_url_options appropriate for a development environment </span>
<span class="go">      in config/environments/development.rb:</span>

<span class="go">        config.action_mailer.default_url_options = { :host =&gt; &#39;localhost:3000&#39; }</span>

<span class="go">      In production, :host should be set to the actual host of your application.</span>

<span class="go">   2. Ensure you have defined root_url to *something* in your config/routes.rb.</span>
<span class="go">      For example:</span>

<span class="go">        root :to =&gt; &quot;home#index&quot;</span>

<span class="go">   3. Ensure you have flash messages in app/views/layouts/application.html.erb.</span>
<span class="go">      For example:</span>

<span class="go">        &lt;p class=&quot;notice&quot;&gt;&lt;%= notice %&gt;&lt;/p&gt;</span>
<span class="go">        &lt;p class=&quot;alert&quot;&gt;&lt;%= alert %&gt;&lt;/p&gt;</span>

<span class="go">   4. If you are deploying Rails 3.1 on Heroku, you may want to set:</span>

<span class="go">        config.assets.initialize_on_precompile = false</span>

<span class="go">      On config/application.rb forcing your application to not access the DB</span>
<span class="go">      or load models when precompiling your assets.</span>

<span class="go"> ===============================================================================</span>
</pre></div>

<p>1.4 look at the files devise has created and read the notes. We&#39;ll address them one by one below:</p>
<div class="highlight"><pre><span class="go">       create  config/initializers/devise.rb</span>
<span class="go">       create  config/locales/devise.en.yml</span>
</pre></div>

<h3>4.1.4. Devise point 1.</h3>

<p>Setup action mailer so that devise can email us any forgotten passwords. To do this we need to tell Devise where the link in the email it will send should point to. Rails allows us to configure environments for <strong>development</strong>, <strong>test</strong> and <strong>production</strong> but for now we&#39;ll just set up the default actionmailer url for our development environment.</p>

<p>In the file config/environments/development.rb add the line <code>config.action_mailer.default_url_options = { :host =&gt; &#39;localhost:3000&#39; }</code></p>
<div class="highlight"><pre><span class="no">Stinkytrainers</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="c1"># Settings specified here will take precedence over those in config/application.rb</span>

  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">&#39;localhost:3000&#39;</span> <span class="p">}</span>

  <span class="c1"># In the development environment your application&#39;s code is reloaded on</span>
  <span class="c1"># every request. This slows down response time but is perfect for development</span>
  <span class="c1"># since you don&#39;t have to restart the web server when you make code changes.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">cache_classes</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="c1"># Log error messages when you accidentally call methods on nil.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">whiny_nils</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># Show full error reports and disable caching</span>
  <span class="n">config</span><span class="o">.</span><span class="n">consider_all_requests_local</span>       <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">perform_caching</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="c1"># Don&#39;t care if the mailer can&#39;t send</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">raise_delivery_errors</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="c1"># Print deprecation notices to the Rails logger</span>
  <span class="n">config</span><span class="o">.</span><span class="n">active_support</span><span class="o">.</span><span class="n">deprecation</span> <span class="o">=</span> <span class="ss">:log</span>

  <span class="c1"># Only use best-standards-support built into browsers</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_dispatch</span><span class="o">.</span><span class="n">best_standards_support</span> <span class="o">=</span> <span class="ss">:builtin</span>

  <span class="c1"># Raise exception on mass assignment protection for Active Record models</span>
  <span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>

  <span class="c1"># Log the query plan for queries taking more than this (works</span>
  <span class="c1"># with SQLite, MySQL, and PostgreSQL)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">auto_explain_threshold_in_seconds</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span>

  <span class="c1"># Do not compress assets</span>
  <span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="c1"># Expands the lines which load the assets</span>
  <span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>

<h3>4.1.5. Devise point 2.</h3>

<p>This is telling us to create a route to our home page. We&#39;ve already covered this in section 2.</p>

<h3>4.1.6. Devise point 3.</h3>

<p>Rails has a convenience system called &#39;Flash&#39;. It has nothing to do with adobe Flash. Flash is a global variable that you can use at any point in your controller and assign a message to <strong>notice</strong> or an <strong>alert</strong> by writing something like:</p>
<div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;I&#39;m afraid you&#39;ve failed Mr Bond&quot;</span>
</pre></div>

<p>This message will then be usd in your view as below. </p>
<div class="highlight"><pre>   <span class="o">&lt;</span><span class="nb">p</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;notice&quot;</span><span class="o">&gt;&lt;</span><span class="sx">%= notice %&gt;&lt;/p&gt;</span>
<span class="sx">   &lt;p class=</span><span class="s2">&quot;alert&quot;</span><span class="o">&gt;&lt;%=</span> <span class="n">alert</span> <span class="sx">%&gt;&lt;/p&gt;</span>
</pre></div>

<p>Add the two lines above to app/views/layouts/application.html.erb below inside the &#39;container&#39; div above <code>yield</code>. <code>yield</code> is where Rails will be putting the output of our view. </p>
<div class="highlight"><pre><span class="o">&lt;!</span><span class="no">DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="nb">name</span><span class="o">=</span><span class="s2">&quot;viewport&quot;</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;&lt;</span><span class="sx">%= content_for?(:title) ? yield(:title) : &quot;StinkyTrainers&quot; %&gt;&lt;/title&gt;</span>
<span class="sx">    &lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="sx">%&gt;</span>

<span class="sx">    &lt;!-- Le HTML5 shim, for IE6-8 support of HTML elements --&gt;</span>
    <span class="o">&lt;!--[</span><span class="k">if</span> <span class="n">lt</span> <span class="no">IE</span> <span class="mi">9</span><span class="o">]&gt;</span>
      <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;http://html5shim.googlecode.com/svn/trunk/html5.js&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;&lt;</span><span class="sr">/script&gt;</span>
<span class="sr">    &lt;![endif]--&gt;</span>

<span class="sr">    &lt;%= stylesheet_link_tag &quot;application&quot;, :media =&gt; &quot;all&quot; %&gt;</span>

<span class="sr">    &lt;link href=&quot;images/</span><span class="n">favicon</span><span class="o">.</span><span class="n">ico</span><span class="s2">&quot; rel=&quot;</span><span class="n">shortcut</span> <span class="n">icon</span><span class="s2">&quot;&gt;</span>
<span class="s2">    &lt;link href=&quot;</span><span class="n">images</span><span class="o">/</span><span class="n">apple</span><span class="o">-</span><span class="n">touch</span><span class="o">-</span><span class="n">icon</span><span class="o">.</span><span class="n">png</span><span class="s2">&quot; rel=&quot;</span><span class="n">apple</span><span class="o">-</span><span class="n">touch</span><span class="o">-</span><span class="n">icon</span><span class="s2">&quot;&gt;</span>
<span class="s2">    &lt;link href=&quot;</span><span class="n">images</span><span class="o">/</span><span class="n">apple</span><span class="o">-</span><span class="n">touch</span><span class="o">-</span><span class="n">icon</span><span class="o">-</span><span class="mi">72</span><span class="n">x72</span><span class="o">.</span><span class="n">png</span><span class="s2">&quot; rel=&quot;</span><span class="n">apple</span><span class="o">-</span><span class="n">touch</span><span class="o">-</span><span class="n">icon</span><span class="s2">&quot; sizes=&quot;</span><span class="mi">72</span><span class="n">x72</span><span class="s2">&quot;&gt;</span>
<span class="s2">    &lt;link href=&quot;</span><span class="n">images</span><span class="o">/</span><span class="n">apple</span><span class="o">-</span><span class="n">touch</span><span class="o">-</span><span class="n">icon</span><span class="o">-</span><span class="mi">114</span><span class="n">x114</span><span class="o">.</span><span class="n">png</span><span class="s2">&quot; rel=&quot;</span><span class="n">apple</span><span class="o">-</span><span class="n">touch</span><span class="o">-</span><span class="n">icon</span><span class="s2">&quot; sizes=&quot;</span><span class="mi">114</span><span class="n">x114</span><span class="s2">&quot;&gt;</span>

<span class="s2">    &lt;link href=&#39;http://fonts.googleapis.com/css?family=Sonsie+One|Vast+Shadow&#39; rel=&#39;stylesheet&#39; type=&#39;text/css&#39;&gt;</span>
<span class="s2">    &lt;link href=&#39;http://fonts.googleapis.com/css?family=Vollkorn&#39; rel=&#39;stylesheet&#39; type=&#39;text/css&#39;&gt;</span>

<span class="s2">  &lt;/head&gt;</span>
<span class="s2">  &lt;body class=&quot;</span><span class="n">stinky</span><span class="s2">&quot;&gt;</span>
<span class="s2">    &lt;%= render &#39;shared/google_analytics&#39; %&gt;</span>
<span class="s2">    &lt;div class=&quot;</span><span class="n">navbar</span> <span class="n">navbar</span><span class="o">-</span><span class="n">fixed</span><span class="o">-</span><span class="n">top</span><span class="s2">&quot;&gt;</span>
<span class="s2">      &lt;div class=&quot;</span><span class="n">navbar</span><span class="o">-</span><span class="n">inner</span><span class="s2">&quot;&gt;</span>
<span class="s2">        &lt;div class=&quot;</span><span class="n">container</span><span class="s2">&quot;&gt;</span>
<span class="s2">          &lt;a class=&quot;</span><span class="n">btn</span> <span class="n">btn</span><span class="o">-</span><span class="n">navbar</span><span class="s2">&quot; data-target=&quot;</span><span class="o">.</span><span class="n">nav</span><span class="o">-</span><span class="n">collapse</span><span class="s2">&quot; data-toggle=&quot;</span><span class="n">collapse</span><span class="s2">&quot;&gt;</span>
<span class="s2">            &lt;span class=&quot;</span><span class="n">icon</span><span class="o">-</span><span class="n">bar</span><span class="s2">&quot;&gt;&lt;/span&gt;</span>
<span class="s2">            &lt;span class=&quot;</span><span class="n">icon</span><span class="o">-</span><span class="n">bar</span><span class="s2">&quot;&gt;&lt;/span&gt;</span>
<span class="s2">            &lt;span class=&quot;</span><span class="n">icon</span><span class="o">-</span><span class="n">bar</span><span class="s2">&quot;&gt;&lt;/span&gt;</span>
<span class="s2">          &lt;/a&gt;</span>

<span class="s2">          &lt;a class=&quot;</span><span class="n">brand</span><span class="s2">&quot; href=&quot;</span><span class="o">/</span><span class="s2">&quot;&gt;Stinkytrainers&lt;/a&gt;</span>
<span class="s2">          &lt;div class=&quot;</span><span class="n">container</span> <span class="n">nav</span><span class="o">-</span><span class="n">collapse</span><span class="s2">&quot;&gt;</span>
<span class="s2">            &lt;ul class=&quot;</span><span class="n">nav</span><span class="s2">&quot;&gt;</span>
<span class="s2">               &lt;li&gt;&lt;%= link_to &quot;</span><span class="n">dashboard</span><span class="s2">&quot;, dashboard_index_path  %&gt;&lt;/li&gt;</span>
<span class="s2">            &lt;/ul&gt;</span>

<span class="s2">          &lt;/div&gt;&lt;!--/.nav-collapse --&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">      &lt;/div&gt;</span>


<span class="s2">    &lt;/div&gt;</span>

<span class="s2">    &lt;h1 class=&quot;</span><span class="n">banner</span><span class="s2">&quot;&gt;&lt;%= yield :title %&gt;&lt;/h1&gt;</span>

<span class="s2">    &lt;div class=&quot;</span><span class="n">container</span><span class="s2">&quot;&gt;</span>

<span class="s2">      &lt;p class=&quot;</span><span class="n">notice</span><span class="s2">&quot;&gt;&lt;%= notice %&gt;&lt;/p&gt;</span>
<span class="s2">      &lt;p class=&quot;</span><span class="n">alert</span><span class="s2">&quot;&gt;&lt;%= alert %&gt;&lt;/p&gt;</span>

<span class="s2">      &lt;div class=&quot;</span><span class="n">content</span><span class="s2">&quot;&gt;</span>
<span class="s2">        &lt;div class=&quot;</span><span class="n">row</span><span class="s2">&quot;&gt;</span>
<span class="s2">           &lt;div class=&quot;</span><span class="n">span9</span><span class="s2">&quot;&gt;</span>

<span class="s2">                &lt;%= yield %&gt;</span>

<span class="s2">            &lt;/div&gt;</span>
<span class="s2">            &lt;div class=&quot;</span><span class="n">span3</span><span class="s2">&quot;&gt;</span>
<span class="s2">                &amp;nbsp;</span>
<span class="s2">            &lt;/div&gt;&lt;!--/span--&gt;</span>
<span class="s2">        &lt;/div&gt;&lt;!--/row--&gt;</span>
<span class="s2">      &lt;/div&gt;&lt;!--/content--&gt;</span>

<span class="s2">      &lt;footer&gt;</span>
<span class="s2">        &lt;p&gt;&amp;copy; Stinky Trainers 2012&lt;/p&gt;</span>
<span class="s2">      &lt;/footer&gt;</span>

<span class="s2">    &lt;/div&gt; &lt;!-- /container --&gt;</span>

<span class="s2">    &lt;!-- Javascripts</span>
<span class="s2">    ================================================== --&gt;</span>
<span class="s2">    &lt;!-- Placed at the end of the document so the pages load faster --&gt;</span>
<span class="s2">    &lt;%= javascript_include_tag &quot;</span><span class="n">application</span><span class="s2">&quot; %&gt;</span>

<span class="s2">  &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
</pre></div>

<p>It has to be said that Flash is very useful for quick applications like ours but less commonly used in bigger apps where this kind of user interaction is determined by the Look &amp; Feel.</p>

<h3>4.1.7. Install the Devise views</h3>

<p>Out of the box Devise will provide the application with views for signing-up, signing-in and forgot-password. These views are contained inside the gem where we can&#39;t change or style them which isn&#39;t that helpful. Luckily Devise gives us a generator that will copy it&#39;s views into our application&#39;s app/views folder where we can make whatever changes we want.</p>
<div class="highlight"><pre><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rails</span> <span class="n">generate</span> <span class="n">devise</span><span class="ss">:views</span>
</pre></div>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/4-secure-the-dashboard-view.html#add-the-devise-gem"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='use-devise-to-create-the-user-model'></a> 4.2. Use Devise to create the User Model</h2>

<h3>4.2.1. Create a User model using the Devise generator.</h3>

<p>This will give us a standard Rails ActiveeRcord model but with some extra authentication methods and attributes needed for Devise. Of course we could add these extra bits by hand ourselves but we&#39;re here to write an application not a framework so we&#39;ll let Devise do this boring stuff for us.</p>
<div class="highlight"><pre><span class="go">rails generate devise user</span>
</pre></div>

<h3>4.2.2. Take a look at what it&#39;s created:</h3>
<div class="highlight"><pre><span class="go">    invoke  active_record</span>
<span class="go">      create    db/migrate/20120629090415_devise_create_users.rb</span>
<span class="go">      create    app/models/user.rb</span>
<span class="go">      invoke    rspec</span>
<span class="go">      create      spec/models/user_spec.rb</span>
<span class="go">      insert    app/models/user.rb</span>
<span class="go">      route  devise_for :users</span>
</pre></div>

<p>The line <code>create    db/migrate/20120629090415_devise_create_users.rb</code> gives us our first database migration db/migrate/{timestamp}<em>devise</em>create_users.rb, a user model <code>app/models/user.rb</code> and a file for writing tests for our user <code>spec/app/models/user.rb</code>.</p>

<h3>4.2.3. Our first migration</h3>

<p>Rails Migrations are a tool for managing the development of SQL Databases. They create tables, rename columns, drop tables, create indexes and pretty much anything else. Migrations are written in Ruby and converted to sql by Rails (or to be more precise the Rails database adapter we&#39;re using). </p>

<p>For example, we could have 4 migrations that </p>

<ol>
<li>create a table called martians.</li>
<li>add an integer column to the table called raygun power.</li>
<li>create an index on the raygun column. </li>
<li>rename the raygun column to number<em>of</em>arms.</li>
</ol>

<p>If we were to run</p>
<div class="highlight"><pre><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">db</span><span class="ss">:migrate</span>
</pre></div>

<p>Then, in a timestamped sequence (each migration name has a timestamp embedded in it) the migrations would carry out those tasks.</p>

<p>Running</p>
<div class="highlight"><pre><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">db</span><span class="ss">:rollback</span>
</pre></div>

<p>Would rollback the migrations by one so the number<em>of</em>arms column would be named back to raygun. Running &#39;bundle exec rake db:rollback&#39; again would drop the indexes on the raygun columns etc..</p>

<p>When I ran the devise generator above it created a migration for our user model <strong>db/migrate/20120629090415<em>devise</em>create_users.rb</strong>. Note that yours will be named a little different as the timestamp in the migration name will reflect when you created it. </p>

<p>Take a look at the migration, it will be the only file in the folder <strong>db/migrate</strong> and you&#39;ll see quite a bit of ruby code for creating the users table that will hold the data for the user model Devise has generated. <strong>Note</strong> that the table name is plural users for a singular model user. Rails is very good at connecting singular and plural words. For example, it will understand that the collection lesson.students will contain student objects. If you&#39;re thinking this is all a bit too constraining, all this is configurable but out of the box we get the functionality we&#39;re probably going to need.</p>

<p>Lets run the migration to create the table in our database:</p>
<div class="highlight"><pre><span class="go">bundle exec rake db:migrate</span>
</pre></div>

<p>You should see some sql statements appear in the console as the migration creates the users table:</p>
<div class="highlight"><pre><span class="go">==  DeviseCreateUsers: migrating ==============================================</span>
<span class="go">-- create_table(:users)</span>
<span class="go">   -&gt; 0.2032s</span>
<span class="go">-- add_index(:users, :email, {:unique=&gt;true})</span>
<span class="go">   -&gt; 0.0037s</span>
<span class="go">-- add_index(:users, :reset_password_token, {:unique=&gt;true})</span>
<span class="go">   -&gt; 0.0022s</span>
<span class="go">==  DeviseCreateUsers: migrated (0.2106s) =====================================</span>
</pre></div>

<p>Also take a look at the file db/schema.rb. This contains an empty schema covering all of our migrations. Schema.rb will be used by Rspec to create an empty test database. It&#39;s also useful when your application gets big and running very many migrations from scratch just isn&#39;t practicable.</p>

<p>Let&#39;s play with migrations a moment and, just for fun, rollback the migration</p>
<div class="highlight"><pre><span class="go">bundle exec rake db:rollback</span>
</pre></div>

<p>and you should see some sql in your console that tells you your table has been dropped from the database. Don&#39;t forget to run <code>bundle exec rake db:migrate</code> so that we rebuild our dropped users table.</p>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/4-secure-the-dashboard-view.html#use-devise-to-create-the-user-model"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='secure-the-dashboard-with-devise'></a> 4.3. Secure the Dashboard with Devise</h2>

<p>To secure the dashboard we&#39;ll add some code to our dashboard_controller that checks to see if we have a user in session that&#39;s already logged-in. Add the line <code>before_filter :authenticate_user!</code> to the dashboard controller app/controllers/dashboard_controller.rb</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">DashboardController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="n">before_filter</span> <span class="ss">:authenticate_user!</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>We&#39;ve added a <code>before filter</code> that calls a dynamic method that Devise will handle for us <code>authenticate_user!</code>. It&#39;s dynamic because the method <code>authenticate_user!</code> doesn&#39;t actually exist which makes sense because the model we&#39;re authenticating against doesn&#39;t have to be a user. We could easily have created an admin model or even a martian model which would require us to <code>authenticate_admin!</code> or <code>authenticate_martian!</code>. Ruby, like most programming languages will throw a <code>NoMethodError</code> if you try to call a method that doesn&#39;t exist but unlike most other languages, before it does, it calls a special method called <code>method_missing</code> that allows our code (in this case Devise) to see if it can make sense of something like <code>authenticate_user!</code>.  Devise can then decide if it wants to act on this missing method so if our code calls <code>authenticate_user!</code> (and we have a user) then Devise will do something. If our code calls <code>authenticate_martian!</code> (and we have no martians in this application) then Devise will ignore it and we&#39;ll get the expected <code>NoMethodError</code>.  </p>

<p>Because it&#39;s a <code>before_filter</code> then <code>authenticate_user!</code> will run before each action in the dashboard controller to ensure we have an authenticated user in the application session.</p>

<p>Now start the app <code>bundle exec rails s</code> browse to the home page <strong>localhost:3000</strong> and click the dashboard link. You should be redirected to a screen asking you to login or sign up. Just sign up as a new user and you should then be directed to the dashboard page. </p>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/4-secure-the-dashboard-view.html#secure-the-dashboard-with-devise"
     data-num-posts="2"
     data-width="auto">
</div>

<h3>4.3.1. Add some code so that we can sign out</h3>

<p>Out of the box Devise gives us views to sign-in, sign-up and even retrieve forgotten passwords but we also need something to sign-out.  </p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="sx">% if </span><span class="n">user_signed_in?</span> <span class="sx">%&gt;</span>
<span class="sx">   &lt;div  style=&quot;text-align: right;&quot;&gt;</span>
    <span class="o">&lt;</span><span class="sx">%= link_to &quot;sign-out&quot;, destroy_user_session_path, :method =</span><span class="o">&gt;</span> <span class="ss">:delete</span>  <span class="sx">%&gt;</span>
<span class="sx">   &lt;/div&gt;</span>
<span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>          
</pre></div>

<p>Add the lines above to app/layouts/application.html.erb:</p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;navbar navbar-fixed-top&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;navbar-inner&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;container&quot;</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">a</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;btn btn-navbar&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">target</span><span class="o">=</span><span class="s2">&quot;.nav-collapse&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">toggle</span><span class="o">=</span><span class="s2">&quot;collapse&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;icon-bar&quot;</span><span class="o">&gt;&lt;</span><span class="sr">/span&gt;</span>
<span class="sr">        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/s</span><span class="n">pan</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;icon-bar&quot;</span><span class="o">&gt;&lt;</span><span class="sr">/span&gt;</span>
<span class="sr">      &lt;/</span><span class="n">a</span><span class="o">&gt;</span>

      <span class="o">&lt;</span><span class="n">a</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;brand&quot;</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="o">&gt;</span><span class="no">Stinkytrainers</span><span class="o">&lt;</span><span class="sr">/a&gt;</span>
<span class="sr">      &lt;div class=&quot;container nav-collapse&quot;&gt;</span>
<span class="sr">        &lt;ul class=&quot;nav&quot;&gt;</span>
<span class="sr">          &lt;% if user_signed_in? %&gt;</span>
<span class="sr">           &lt;div  style=&quot;text-align: right;&quot;&gt;</span>
<span class="sr">            &lt;%= link_to &quot;sign-out&quot;, destroy_user_session_path, :method =&gt; :delete  %&gt;</span>
<span class="sr">           &lt;/</span><span class="n">div</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
<span class="sx">        &lt;/ul&gt;</span>
      <span class="o">&lt;</span><span class="sr">/div&gt;&lt;!--/</span><span class="o">.</span><span class="n">nav</span><span class="o">-</span><span class="n">collapse</span> <span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="sr">/div&gt;</span>
<span class="sr">  &lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/div&gt;</span>
</pre></div>

<p>Forgive the inline style but this isn&#39;t a tutorial on css.</p>

<p>user_signed_in? is a helper method generated by devise, link<em>to is a Rails helper for generating html links. In this case we&#39;re generating a link with text &#39;sign-out&#39; and a url generated by the devise named route 
destroy\</em>user_session_path. We&#39;ll cover Devise routes a bit more below.</p>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/4-secure-the-dashboard-view.html#secure-the-dashboard-with-devise"
     data-num-posts="2"
     data-width="auto">
</div>

<p><a href="#top">back to top</a></p>

<h2><a id='testing-the-dashboard-is-locked-down'></a> 4.4. Testing the Dashboard is locked down</h2>

<p>Typically with Test Driven Development you would write tests first and then make them pass but in this particular case I wanted you to see Devise in action so that the tests have some meaning. </p>

<p>Let&#39;s test Devise by writing two tests for our dashboard controller:</p>

<ol>
<li>A test that checks we are not allowed to see the dashboard index page and get redirected to the sign-in page if the user hasn&#39;t signed-in.</li>
<li>A test that checks we are allowed to see the dashboard index page if the user has signed-in.</li>
<li>A test that we can sign-up and go to the dashboard index page</li>
</ol>

<p>Before we start we need to include some helper methods that Devise gives us so that it can participate in our tests. </p>

<p>Create the file <code>spec/support/devise.rb</code> (you&#39;ll probably have to create the spec/support folder) and add these lines:</p>
<div class="highlight"><pre><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">include</span> <span class="no">Devise</span><span class="o">::</span><span class="no">TestHelpers</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:controller</span>
<span class="k">end</span>
</pre></div>

<h3>4.4.1. Testing the redirect</h3>

<p>Let&#39;s test that our dashboard controller redirects us to a sign-in page when there is no signed-in user</p>

<p>In <code>spec/controllers/dashboard_controller_spec.rb</code></p>
<div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should redirect to the login page when the user is not signed-in&quot;</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s1">&#39;index&#39;</span>
  <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">new_user_session_path</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>and run the test.</p>
<div class="highlight"><pre><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">spec</span>
</pre></div>

<p>You should see the test passes in console </p>

<p>NOTE that <code>new_user_session_path</code> is another named route. Open <code>config/routes.rb</code> and you&#39;ll see the line <code>devise_for :users</code></p>
<div class="highlight"><pre><span class="no">Stinkytrainers</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>

 <span class="n">devise_for</span> <span class="ss">:users</span>

 <span class="n">resources</span> <span class="ss">:dashboard</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="o">]</span> 

 <span class="n">root</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;home#index&#39;</span>

<span class="k">end</span>
</pre></div>

<p>somewhere near the top. This is devise adding a bunch of new routes for creating and destroying use sessions. You can see them in console by running:</p>
<div class="highlight"><pre><span class="go">bundle exec rake routes</span>
</pre></div>

<p>which should return</p>
<div class="highlight"><pre><span class="go"> new_user_session GET    /users/sign_in(.:format)          devise/sessions#new</span>
<span class="go">            user_session POST   /users/sign_in(.:format)          devise/sessions#create</span>
<span class="go">    destroy_user_session DELETE /users/sign_out(.:format)         devise/sessions#destroy</span>
<span class="go">           user_password POST   /users/password(.:format)         devise/passwords#create</span>
<span class="go">       new_user_password GET    /users/password/new(.:format)     devise/passwords#new</span>
<span class="go">      edit_user_password GET    /users/password/edit(.:format)    devise/passwords#edit</span>
<span class="go">                         PUT    /users/password(.:format)         devise/passwords#update</span>
<span class="go">cancel_user_registration GET    /users/cancel(.:format)           devise/registrations#cancel</span>
<span class="go">       user_registration POST   /users(.:format)                  devise/registrations#create</span>
<span class="go">   new_user_registration GET    /users/sign_up(.:format)          devise/registrations#new</span>
<span class="go">  edit_user_registration GET    /users/edit(.:format)             devise/registrations#edit</span>
<span class="go">                         PUT    /users(.:format)                  devise/registrations#update</span>
<span class="go">                         DELETE /users(.:format)                  devise/registrations#destroy</span>
<span class="go">         dashboard_index GET    /dashboard/index(.:format)        dashboard#index</span>
<span class="go">                         GET    /dashboard(.:format)              dashboard#index</span>
<span class="go">                         GET    /rails-tutorial(/*path)(.:format) tutorial#index</span>
<span class="go">                    root        /                                 home#index</span>
</pre></div>

<p>You can see that <strong>new_user_session</strong> returns the path <strong>/users/sign_in</strong> which points to the new method of a devise sessions controller. Remember that we use <strong>new_user_session</strong> by adding either _path or _url to the end depending on whether we want a full url or not.</p>

<p><a href="#top">back to top</a></p>

<h2><a id='test-signed-in-users-can-see-the-dashboard'></a> 4.5. Test signed-in users can see the Dashboard</h2>

<p>Let&#39;s create a test that calls the index page of our secure dashboard_controller. </p>

<p>add this test to spec/controllers/dashboard_controller_spec.rb beneath our passing test.</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should render the index page when the user is signed-in&quot;</span> <span class="k">do</span>
 <span class="n">get</span> <span class="s1">&#39;index&#39;</span>
 <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
<span class="k">end</span>
</pre></div>

<p>Note that we call <code>get &#39;index&#39;</code> in the same way as our first test but this time we expect it to succeed rather than redirect.</p>

<p>Run the test</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p>you should see that the test fails: </p>
<div class="highlight"><pre><span class="go"> 1) DashboardController GET &#39;index&#39; should render the index page when the user is signed-in</span>
<span class="go">   Failure/Error: response.should be_success</span>
<span class="go">   expected success? to return true, got false</span>
<span class="go">    ./spec/controllers/dashboard_controller_spec.rb:13:in `block (3 levels) in &lt;top (required)&gt;&#39;</span>
</pre></div>

<p>That&#39;s because we haven&#39;t yet signed-in a user so we&#39;re being redirected away in just the same way as our first test so let&#39;s fix our breaking test by adding <code>sign_in :user, User.create(:email =&gt; &#39;foo@domain.com&#39;, :password =&gt; &#39;simple&#39;)</code></p>
<div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should render the index page when the user is signed-in&quot;</span> <span class="k">do</span>
   <span class="n">sign_in</span> <span class="ss">:user</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;foo@domain.com&#39;</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s1">&#39;simple&#39;</span><span class="p">)</span>
   <span class="n">get</span> <span class="s1">&#39;index&#39;</span>
   <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
<span class="k">end</span>
</pre></div>

<p>The test should now pass when you run <code>bundle exec rake spec</code></p>

<h3>4.5.1. Change the test to use FactoryGirl.</h3>

<p>We&#39;ve got the test passing but it feels wrong to create a new user each time we want to run a test so we&#39;re going to use a gem called FactoryGirl. FactoryGirl will, on demand, create test users (and other objects) for us. As our user gets more complex, FactoryGirl will become a clear and convenient way to build objects for testing rather than create new ones from scratch each time.</p>

<p>First let&#39;s add the FactoryGirl gem to our Gemfile&#39;s testing group:</p>
<div class="highlight"><pre><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span>
<span class="k">end</span>
</pre></div>

<p>then install the Factory Girl</p>
<div class="highlight"><pre><span class="go">bundle install</span>
</pre></div>

<p>Factory Girl allows us to create Factories that define a typical test user so let&#39;s create a factory file for our first User factory. Create <strong>spec/factories.rb</strong> then add these lines to the file:</p>
<div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">sequence</span> <span class="ss">:email</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
   <span class="s2">&quot;person</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@domain.com&quot;</span>
  <span class="k">end</span>

  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">email</span> <span class="p">{</span> <span class="n">generate</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span> 
    <span class="n">password</span> <span class="s1">&#39;password&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>This factory will create users with a sequence of unique emails &quot;person1@domain.com&quot;, &quot;person2@domain.com&quot;, &quot;person3@domain.com&quot; etc..</p>

<p>Now let&#39;s use FactoryGirl in our test:</p>

<p>In <code>spec/controllers/dashboard_controller_spec.rb</code> replace the line:</p>
<div class="highlight"><pre><span class="n">sign_in</span> <span class="ss">:user</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s1">&#39;foo@domain.com&#39;</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s1">&#39;simple&#39;</span><span class="p">)</span>
</pre></div>

<p>with</p>
<div class="highlight"><pre><span class="n">sign_in</span> <span class="ss">:user</span><span class="p">,</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</pre></div>

<p>now check that it&#39;s all still working</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec  </span>
</pre></div>

<p><a href="#top">back to top</a></p>

<h2><a id='testing-we-can-sign-in-and-see-the-dashboard'></a> 4.6. Testing we can sign-in and see the Dashboard</h2>

<p>We&#39;ve tested that we have to be signed-in to see the dashboard index page so now let&#39;s test that we CAN sign in. Create the folder and file spec/integration/dashboard/authentication_spec.rb and add these lines:</p>
<div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s1">&#39;only registered users can access dashboard&#39;</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s1">&#39;should require users to sign in when they trying to access dashboard&#39;</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

    <span class="n">visit</span> <span class="n">dashboard_index_url</span>

    <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">new_user_session_path</span>

    <span class="c1"># &#39;Email&#39; and &#39;Password&#39; are the text in the HTML labels on the sign in screen</span>
    <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Email&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Password&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

    <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span>

    <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">dashboard_index_path</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>We&#39;re using the Capybara gem to journey through our application as if we were browsing. The test:</p>

<ol>
<li>creates a user.</li>
<li>tries the visit the dashboard index page.</li>
<li>confirms that we are actually on the sign-in page.</li>
<li>fills in the email and passowrd of the user Factory girl created for us.</li>
<li>clicks sign-in,</li>
<li>confirms that we are now on the dashboard index page.</li>
</ol>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p>and it should pass.</p>

<p><a href="#top">back to top</a></p>

<h2><a id='testing-we-can-sign-up-and-see-the-dashboard'></a> 4.7. Testing we can sign-up and see the Dashboard</h2>

<p>Lastly, we want users that aren&#39;t logged-in and don&#39;t have an account with us to be able to sign-up and then see the dashboard index page. Add this to spec/integration/dashboard/authentication_spec.rb</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should allow users without an account to sign-up then access the dashboard&#39;</span> <span class="k">do</span>

  <span class="n">visit</span> <span class="n">dashboard_index_url</span>

  <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">new_user_session_path</span>

  <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;Sign up&#39;</span><span class="p">)</span>

  <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">new_user_registration_path</span>

  <span class="c1"># &#39;Email&#39; and &#39;Password&#39; are the text in the HTML labels on the sign in screen</span>
  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Email&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;joe@bloggsxyz.com&#39;</span><span class="p">)</span>
  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Password&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;JoeBlogg1&#39;</span><span class="p">)</span>
  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Password confirmation&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;JoeBlogg1&#39;</span><span class="p">)</span>

  <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Sign up&#39;</span><span class="p">)</span>

  <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">dashboard_index_path</span>
<span class="k">end</span>
</pre></div>

<p>This time the journey through our application is:</p>

<ol>
<li>try to visit the dashboard index page.</li>
<li>confirm that we are actually on the sign-in page.</li>
<li>click the &#39;Sign up&#39; link</li>
<li>confirm we&#39;re on the sign-up page which is the named route <code>new_user_registration_path</code></li>
<li>fill in the email, password and password confirmation.</li>
<li>click &#39;Sign up&#39;,</li>
<li>confirm that we are now on the dashboard index page.</li>
</ol>

<p>Each time we run this test we&#39;re creating a user with the same name and password. This brings us to a very important point about Rails testing. We already mentioned that Rails has development, testing and production environments. Each environment has its own database. Look at config/database.yml:</p>
<div class="highlight"><pre><span class="nb">test</span><span class="p">:</span>
  <span class="n">adapter</span><span class="p">:</span> <span class="n">sqlite3</span>
  <span class="n">database</span><span class="p">:</span> <span class="n">db</span><span class="o">/</span><span class="nb">test</span><span class="o">.</span><span class="n">sqlite3</span>
  <span class="n">pool</span><span class="p">:</span> <span class="mi">5</span>
  <span class="n">timeout</span><span class="p">:</span> <span class="mi">5000</span>
</pre></div>

<p>We can see that for testing we have a database called db/test.sqlite3 so that we don&#39;t do anything to mess up the data we&#39;ve been using in development. Rails also runs each test inside a transaction that rolls back when each test is complete so we can run the test above a thousand times and it will never actually persisting the user we created to our test database. </p>

<div class="fb-comments"
     data-href="http://www.stinkytrainers.co.uk/ruby-on-rails-tutorial/4-secure-the-dashboard-view.html#testing-we-can-sign-up-and-see-the-dashboard"
     data-num-posts="2"
     data-width="auto">
</div>
