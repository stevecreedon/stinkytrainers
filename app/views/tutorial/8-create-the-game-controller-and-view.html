<p><a id='top'></a></p>

<h1>8. The Game Controller and View</h1>

<ol>
<li><a href="#generate-the-controller">Generate the controller</a></li>
<li><a href="#our-draft-functional-tests-for-the-games-controller">Our draft functional tests for the games controller</a></li>
<li><a href="#testing-authentication">Testing authentication</a></li>
<li><a href="#testing-the-index-action">Testing the index action</a></li>
<li><a href="#creating-games">Creating Games</a></li>
<li><a href="#testing-the-edit-updates-actions">Testing the edit/updates actions</a></li>
<li><a href="#testing-the-show-action">Testing the show action</a></li>
<li><a href="#testing-the-destroy-action">Testing the destroy action</a></li>
</ol>

<p>We want to be able to carry out the full RESTful actions on game:</p>

<ol>
<li>List - the index action</li>
<li>Create - the new &gt; create actions</li>
<li>Edit - the edit &gt; update actions</li>
<li>Show - the show action</li>
<li>Destroy - the destroy action</li>
</ol>

<p>So we&#39;re going to generate the controller, set the controller up as a RESTful resource in our routes, write the functional tests then make them all pass.</p>

<h2><a id='generate-the-controller'></a> 8.1. Generate the controller</h2>

<p>We&#39;ll tell the generator to all of the RESTful actions for us.</p>
<div class="highlight"><pre><span class="go">rails generate controller games index new create update edit show destroy</span>

<span class="go">create  app/controllers/games_controller.rb</span>
<span class="go">      route  get &quot;games/destroy&quot;</span>
<span class="go">      route  get &quot;games/show&quot;</span>
<span class="go">      route  get &quot;games/edit&quot;</span>
<span class="go">      route  get &quot;games/update&quot;</span>
<span class="go">      route  get &quot;games/create&quot;</span>
<span class="go">      route  get &quot;games/new&quot;</span>
<span class="go">      route  get &quot;games/index&quot;</span>
<span class="go">     invoke  erb</span>
<span class="go">     create    app/views/games</span>
<span class="go">     create    app/views/games/index.html.erb</span>
<span class="go">     create    app/views/games/new.html.erb</span>
<span class="go">     create    app/views/games/create.html.erb</span>
<span class="go">     create    app/views/games/update.html.erb</span>
<span class="go">     create    app/views/games/edit.html.erb</span>
<span class="go">     create    app/views/games/show.html.erb</span>
<span class="go">     create    app/views/games/destroy.html.erb</span>
<span class="go">     invoke  rspec</span>
<span class="go">     create    spec/controllers/games_controller_spec.rb</span>
<span class="go">     create    spec/views/games</span>
<span class="go">     create    spec/views/games/index.html.erb_spec.rb</span>
<span class="go">     create    spec/views/games/new.html.erb_spec.rb</span>
<span class="go">     create    spec/views/games/create.html.erb_spec.rb</span>
<span class="go">     create    spec/views/games/update.html.erb_spec.rb</span>
<span class="go">     create    spec/views/games/edit.html.erb_spec.rb</span>
<span class="go">     create    spec/views/games/show.html.erb_spec.rb</span>
<span class="go">     create    spec/views/games/destroy.html.erb_spec.rb</span>
<span class="go">     invoke  helper</span>
<span class="go">     create    app/helpers/games_helper.rb</span>
<span class="go">     invoke    rspec</span>
<span class="go">     create      spec/helpers/games_helper_spec.rb</span>
<span class="go">     invoke  assets</span>
<span class="go">     invoke    coffee</span>
<span class="go">     create      app/assets/javascripts/games.js.coffee</span>
<span class="go">     invoke    scss</span>
<span class="go">     create      app/assets/stylesheets/games.css.scss</span>
</pre></div>

<p>Let&#39;s create games as a RESTful resource in <code>config/routes.rb</code> by removing:</p>
<div class="highlight"><pre><span class="n">get</span> <span class="s2">&quot;games/index&quot;</span>

<span class="n">get</span> <span class="s2">&quot;games/new&quot;</span>

<span class="n">get</span> <span class="s2">&quot;games/create&quot;</span>

<span class="n">get</span> <span class="s2">&quot;games/update&quot;</span>

<span class="n">get</span> <span class="s2">&quot;games/edit&quot;</span>

<span class="n">get</span> <span class="s2">&quot;games/show&quot;</span>

<span class="n">get</span> <span class="s2">&quot;games/destroy&quot;</span>
</pre></div>

<p>and creating games as a resource. Since we&#39;re using all of the RESTful actions then we don&#39;t need to limit it with <code>:only =&gt;[]</code> </p>
<div class="highlight"><pre><span class="no">Stinkytrainers</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>


  <span class="n">devise_for</span> <span class="ss">:users</span>

  <span class="n">resources</span> <span class="ss">:sports</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="n">resources</span> <span class="ss">:dashboard</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="o">]</span> 

  <span class="n">resources</span> <span class="ss">:games</span>

  <span class="n">root</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;home#index&#39;</span>

<span class="k">end</span>
</pre></div>

<p>Take a look at the routes we&#39;ve created</p>
<div class="highlight"><pre><span class="go">bundle exec rake routes</span>

<span class="go"> new_user_session GET    /users/sign_in(.:format)                  devise/sessions#new</span>
<span class="go">            user_session POST   /users/sign_in(.:format)                  devise/sessions#create</span>
<span class="go">    destroy_user_session DELETE /users/sign_out(.:format)                 devise/sessions#destroy</span>
<span class="go">           user_password POST   /users/password(.:format)                 devise/passwords#create</span>
<span class="go">       new_user_password GET    /users/password/new(.:format)             devise/passwords#new</span>
<span class="go">      edit_user_password GET    /users/password/edit(.:format)            devise/passwords#edit</span>
<span class="go">                         PUT    /users/password(.:format)                 devise/passwords#update</span>
<span class="go">cancel_user_registration GET    /users/cancel(.:format)                   devise/registrations#cancel</span>
<span class="go">       user_registration POST   /users(.:format)                          devise/registrations#create</span>
<span class="go">   new_user_registration GET    /users/sign_up(.:format)                  devise/registrations#new</span>
<span class="go">  edit_user_registration GET    /users/edit(.:format)                     devise/registrations#edit</span>
<span class="go">                         PUT    /users(.:format)                          devise/registrations#update</span>
<span class="go">                         DELETE /users(.:format)                          devise/registrations#destroy</span>
<span class="go">                  sports GET    /sports(.:format)                         sports#index</span>
<span class="go">                         POST   /sports(.:format)                         sports#create</span>
<span class="go">               new_sport GET    /sports/new(.:format)                     sports#new</span>
<span class="go">                   sport DELETE /sports/:id(.:format)                     sports#destroy</span>
<span class="go">         dashboard_index GET    /dashboard(.:format)                      dashboard#index</span>
<span class="go">                   games GET    /games(.:format)                          games#index</span>
<span class="go">                         POST   /games(.:format)                          games#create</span>
<span class="go">                new_game GET    /games/new(.:format)                      games#new</span>
<span class="go">               edit_game GET    /games/:id/edit(.:format)                 games#edit</span>
<span class="go">                    game GET    /games/:id(.:format)                      games#show</span>
<span class="go">                         PUT    /games/:id(.:format)                      games#update</span>
<span class="go">                         DELETE /games/:id(.:format)                      games#destroy</span>
<span class="go">                    root        /                                         home#index</span>
</pre></div>

<p>You can see we now have games routes matching each of our actions. As a quick reminder of RESTful routes let&#39;s review the routes we&#39;ve created. I&#39;ve assumed we already have a game with the id 179:</p>

<table>
    <tr>
        <th>url</th>
        <th>action</th>
    </tr>
    <tr>
        <td>GET /games</td>
        <td>games#index</td>
    </tr>
    <tr>
        <td>POST /games</td>
        <td>games#create</td>
    </tr>
    <tr>
        <td>GET /games/new</td>
        <td>games#new</td>
    </tr>
    <tr>
        <td>GET /games/179/edit</td>
        <td>games#edit with params[:id] = 179</td>
    </tr>
    <tr>
        <td>GET /games/179</td>
        <td>games#show with params[:id] = 179</td>
    </tr>
    <tr>
        <td>PUT /games/179</td>
        <td>games#update with params[:id] = 179</td>
    </tr>
    <tr>
        <td>DELETE /games/179</td>
        <td>games#destroy with params[:id] = 179</td>
    </tr>
</table>

<p><a href="#top">back to top</a></p>

<h2><a id='our-draft-functional-tests-for-the-games-controller'></a> 8.2. Our draft functional tests for the games controller</h2>

<p>I&#39;m going to introduce the concept of describe blocks in testing here. They let us group our tests together and each block can have its own setup and teardown code. Don&#39;t worry if you&#39;re not sure what setup and teardown means all will become apparent.</p>

<p>Before we write our draft tests we must delete the file <code>spec/constrollers/games_controller_spec.rb</code> since we&#39;re testing views and controllers together as integration tests.</p>

<p>Create the file spec/integration/games/resftful_spec.rb and add the empty draft tests below: </p>
<div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s1">&#39;games&#39;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s1">&#39;authentication&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should redirect users to the sign-in page when they are not signed-in&#39;</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">&#39;listing games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should display a list of the games owned by the signed-in user&#39;</span>
    <span class="n">it</span> <span class="s1">&#39;should display a list of the games where the signed-in user is a player&#39;</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">&#39;creating games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should create a new game when valid game parameters are provided&#39;</span>
    <span class="n">it</span> <span class="s1">&#39;should redirect users back to the new page with user input when incorrect parameters are provided&#39;</span>
  <span class="k">end</span>


  <span class="n">describe</span> <span class="s1">&#39;editing games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should edit a game and update it when the values are valid&#39;</span>
    <span class="n">it</span> <span class="s1">&#39;should edit a game and return then to the edit page with their edited input when incorrect parameters are provided&#39;</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">&#39;showing games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should allow users to view a game&#39;</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">&#39;destroying games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should allow users to destroy a game and redirect them back to the index page&#39;</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p><a href="#top">back to top</a></p>

<h2><a id='testing-authentication'></a> 8.3. Testing authentication</h2>

<p>The test we need to pass is <code>it &#39;should redirect users to the sign-in page when they are not signed-in&#39;</code></p>

<p>This is very similar to our previous authentication tests. Create the file <code>spec/integration/games/authentication_spoec.rb</code> and add this code:</p>
<div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s1">&#39;authentication&#39;</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">&#39;should require users to sign in when they trying to access sports&#39;</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

    <span class="n">visit</span> <span class="n">games_path</span>

    <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">new_user_session_path</span>

    <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Email&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Password&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

    <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span>

    <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">games_path</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Run the tests:</p>
<div class="highlight"><pre><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">spec</span>
</pre></div>

<p>You should see one failure because we haven&#39;t secured the games<em>controller yet. So we&#39;ll do that now by adding the Devise `authenticate</em>user!`</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">GamesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="n">before_filter</span> <span class="ss">:authenticate_user!</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Run the tests again and it should all pass</p>
<div class="highlight"><pre><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">spec</span>
</pre></div>

<p><a href="#top">back to top</a></p>

<h2><a id='testing-the-index-action'></a> 8.4. Testing the index action</h2>

<p>Our previous sports controller index action was quite simple, all we wanted to do is list all sports. This one is a little more difficult as we want to list two things:</p>
<div class="highlight"><pre><span class="n">describe</span> <span class="s1">&#39;listing games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should display a list of the games owned by the signed-in user&#39;</span>
    <span class="n">it</span> <span class="s1">&#39;should display a list of the games where the signed-in user is a player&#39;</span>
<span class="k">end</span>
</pre></div>

<h3>8.4.1. Make our games Factory more useful</h3>

<p>Before we start writing tests, Games require owners and sports so our integration tests are going to be using FactoryGirl to create these objects quite frequently.</p>

<p>Our current games factory <code>spec/factories/games.rb</code> looks something like this</p>
<div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:game</span> <span class="k">do</span>
    <span class="n">location</span> <span class="s2">&quot;MyString&quot;</span>
    <span class="n">at</span> <span class="s2">&quot;2012-09-09 10:00:00&quot;</span>
    <span class="n">sport</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:sport</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">owner</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>So in our tests the :location and :at fields always have the same values which isn&#39;t really realistic or helpful. Update it so that, like email in the user factory and name in the sport factory, locations and times are always different. </p>
<div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:game</span> <span class="k">do</span>
    <span class="n">location</span> <span class="p">{</span> <span class="n">generate</span><span class="p">(</span><span class="ss">:location</span><span class="p">)</span> <span class="p">}</span> 
    <span class="n">at</span> <span class="p">{</span> <span class="n">generate</span><span class="p">(</span><span class="ss">:at</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">sport</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:sport</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">owner</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>          
  <span class="k">end</span>

  <span class="n">sequence</span> <span class="ss">:location</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
    <span class="s2">&quot;location</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>

  <span class="n">sequence</span> <span class="ss">:at</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
    <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h3>8.4.2. Make our external player Factory more useful</h3>

<p>Lets make the email a sequence like user. We don&#39;t have to define the sequence as we can just use the one from user. In spec/factories/external_players.rb</p>
<div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:external_player</span> <span class="k">do</span>
    <span class="n">email</span><span class="p">{</span> <span class="n">generate</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h3>8.4.3. it &#39;should be possible for a signed-in user to navigate from the dashboard page to the game index page&#39;</h3>

<p>We want to make sure our navigation bar has a &#39;games&#39; link. We&#39;ll write a test that</p>

<ol>
<li>Creates and signs-in a user</li>
<li>Visits the dashboard page</li>
<li>Ensures there&#39;s a &#39;games&#39; lik in the navigation bar.</li>
</ol>

<p>This entire spec (and it&#39;s going to be a big one) will require a signed-in user for every test so before we doning anything else let&#39;s create a before(:each) block inside the <code>describe games</code> block. This will run before each test giving us a signed-in user <code>@user</code> so we don&#39;t have to keep writing the same login code over and over again. Again because we assign user to the instance variable <code>@user</code> and not just <code>user</code> it&#39;s available throughout the test.</p>
<div class="highlight"><pre><span class="n">describe</span> <span class="s1">&#39;games&#39;</span> <span class="k">do</span>

  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

    <span class="n">visit</span> <span class="n">new_user_session_path</span>

    <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Email&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Password&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

    <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div>

<p>We can now write our test knowing that Devise isn&#39;t going to boot us out each time.</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should be possible to navigate from the dashboard page to the game index page&#39;</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">dashboard_index_path</span>

    <span class="n">within</span><span class="p">(</span><span class="s2">&quot;ul.nav&quot;</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">page</span><span class="o">.</span><span class="n">has_link?</span><span class="p">(</span><span class="s2">&quot;games&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Run the tests</p>
<div class="highlight"><pre><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">spec</span>
</pre></div>

<p>and the test will fail because we don&#39;t have the link in our layout <code>app/views/layouts/application.html.erb</code></p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">ul</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;nav&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="sx">% if </span><span class="n">user_signed_in?</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;li&gt;</span><span class="o">&lt;</span><span class="sx">%= link_to &quot;dashboard&quot;, dashboard_index_path  %&gt;&lt;/li&gt;</span>
<span class="sx">    &lt;li&gt;&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;games&quot;</span><span class="p">,</span> <span class="n">games_path</span>  <span class="sx">%&gt;&lt;/li&gt;</span>
    <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="sx">%= link_to &quot;sports&quot;, sports_path  %&gt;&lt;/li&gt;</span>
<span class="sx">    &lt;li&gt;&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sign-out&quot;</span><span class="p">,</span> <span class="n">destroy_user_session_path</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span>  <span class="sx">%&gt;&lt;/li&gt;</span>
  <span class="o">&lt;</span><span class="sx">% else %&gt;</span>
<span class="sx">        &lt;li&gt;</span><span class="o">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign In&quot;</span><span class="p">,</span> <span class="n">new_user_session_path</span> <span class="sx">%&gt;&lt;/li&gt;</span>
  <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
<span class="sx">&lt;/ul&gt;</span>
</pre></div>

<h3>8.4.4. it &#39;should display a list of the games owned by the signed-in user&#39;</h3>

<p>So now let&#39;s code the first of our two tests.</p>

<p>Write a test to: </p>

<ol>
<li>Create our signed-in user</li>
<li>Create another user that isn&#39;t the signed-in user</li>
<li>Create three games, two owned by the signed-in user and one owned by the user not signed-in</li>
<li>Ensure that the games we added to the user appears in the &#39;owned_games&#39; table on index page</li>
<li>Ensure that the game we didn&#39;t add to the signed-in user <strong>doesn&#39;t appear</strong> in the &#39;owned_games&#39; table on  the index page</li>
</ol>

<p>Note that we check for the existence of the games inside these within blocks</p>
<div class="highlight"><pre><span class="n">within</span><span class="p">(</span><span class="s2">&quot;table#owned_games&quot;</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Which basically means the test is more than requiring the games to appear on the page, it&#39;s requiring the games to appear within a table with id my_games and a table row with the data-row attribute data-row=&#39;game_x&#39; where x is the id of the game in that row.</p>

<p>We could also have used more specific XPath and css attributes to specify where the games appear but then we&#39;d have to keep fixing our tests each time the page design was altered. This approach feels like a reasonably pragmatic balance between not caring where the games appear and being very specific.</p>
<div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s1">&#39;games&#39;</span> <span class="k">do</span>

  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

    <span class="n">visit</span> <span class="n">new_user_session_path</span>

    <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Email&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Password&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

    <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="n">describe</span> <span class="s1">&#39;listing games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should display a list of the games owned by the signed-in user&#39;</span> <span class="k">do</span>

        <span class="n">other_user</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

        <span class="n">game1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
        <span class="n">game2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
        <span class="n">game3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="n">other_user</span><span class="p">)</span>

        <span class="n">visit</span> <span class="n">games_path</span>

        <span class="n">within</span><span class="p">(</span><span class="s2">&quot;table#owned_games&quot;</span><span class="p">)</span> <span class="k">do</span>

          <span class="vi">@user</span><span class="o">.</span><span class="n">owned_games</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">game</span><span class="o">|</span>
            <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
              <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
              <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
              <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">at</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="k">end</span>

          <span class="n">other_user_game</span> <span class="o">=</span> <span class="n">other_user</span><span class="o">.</span><span class="n">owned_games</span><span class="o">.</span><span class="n">first</span>
          <span class="c1">#page.save_and_show_page</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_content</span><span class="p">(</span><span class="n">other_user_game</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_content</span><span class="p">(</span><span class="n">other_user_game</span><span class="o">.</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_content</span><span class="p">(</span><span class="n">other_user_game</span><span class="o">.</span><span class="n">at</span><span class="p">)</span>

        <span class="k">end</span>

    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">&#39;should display a list of the games where the signed-in user is a player&#39;</span>

  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">&#39;creating games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should create a new game when valid game parameters are provided with the current user selected as a player&#39;</span>
    <span class="n">it</span> <span class="s1">&#39;should redirect users back to the new page with user input when incorrect parameters are provided&#39;</span>
  <span class="k">end</span>


  <span class="n">describe</span> <span class="s1">&#39;editing games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should edit a game and update it when the values are valid&#39;</span>
    <span class="n">it</span> <span class="s1">&#39;should edit a game and return then to the edit page with their edited input when incorrect parameters are provided&#39;</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">&#39;showing games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should allow users to view a game&#39;</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">&#39;destroying games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should allow users to destroy a game and redirect them back to the index page&#39;</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>run the tests...</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p>and it should fail because we haven&#39;t coded the controller or the view we&#39;re testing.</p>

<p>Let&#39;s start with the games controller <code>app/controllers/games_controller.rb</code>. It couldn&#39;t be simpler. In our previous sports controller we wanted all sports to be listed so we coded</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span>
  <span class="vi">@sports</span> <span class="o">=</span> <span class="no">Sport</span><span class="o">.</span><span class="n">all</span>
<span class="k">end</span>
</pre></div>

<p>but now we want to list the games of the logged-in user (we can be sure we have a logged-in user because our previous spec required that). All we need do assign the games of the current user to variable @games which is passed to our view. Note that only instance (or &#39;@&#39;) variables get passed on to the view. Variables that aren&#39;t prefixed &#39;@&#39; are local to the method only. </p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">GamesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="n">before_filter</span> <span class="ss">:authenticate_user!</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@owned_games</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">owned_games</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>You can try running the tests but they should still fail as we haven&#39;t coded the view. Let&#39;s do that now:</p>

<p>in <code>app/views/games/index.html.erb</code></p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Games</span><span class="c1">#index&lt;/h1&gt;</span>

<span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="no">Game</span> <span class="n">I</span> <span class="n">have</span> <span class="n">created</span><span class="o">&lt;</span><span class="sr">/h2&gt;</span>
<span class="sr">&lt;table id=&quot;owned_games&quot;&gt;</span>
<span class="sr">    &lt;% @owned_games.each do |game| %&gt;</span>
<span class="sr">    &lt;tr data-row=&#39;game_&lt;%= game.id %&gt;&#39;&gt;</span>
<span class="sr">        &lt;td&gt;&lt;%= game.sport.name %&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="sx">%= game.location %&gt;&lt;/td&gt;</span>
<span class="sx">        &lt;td&gt;&lt;%=</span> <span class="n">game</span><span class="o">.</span><span class="n">at</span> <span class="sx">%&gt;&lt;/td&gt;</span>
    <span class="o">&lt;</span><span class="sr">/tr&gt;</span>
<span class="sr">    &lt;% end %&gt;</span>
<span class="sr">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
</pre></div>

<p>Note that we use the <code>@owned_games</code> variable from our controller and insert the game id into the data-row attribute of the table.</p>

<p>Our test should now pass:</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<h3>8.4.5. it &#39;should display a list of the games where the signed-in user is a player&#39;</h3>

<p>Now let&#39;s add the test that checks the list of games the signed-in user is playing in.</p>

<p>In this test we will</p>

<ol>
<li>Create three games, two owned by the signed-in user and a third by another user</li>
<li>Add the signed-in user to one of the two games he/she created and add the signed-in user to the game created by the other user.</li>
<li>Test that the table &quot;games&quot; has the two games in which the signed-in user is a player - that&#39;s one of his games and one of the other user&#39;s games.</li>
<li>Test that the table &quot;games&quot; doesn&#39;t have the game in which the signed-in user isn&#39;t a player even though that&#39;s a game he created.</li>
</ol>

<p>Add this code to the second of our two index page tests:</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should display a list of the games the signed-in user is playing in&#39;</span> <span class="k">do</span>

    <span class="n">game1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
    <span class="n">game2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
    <span class="n">game3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>

    <span class="n">game1</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>
    <span class="n">game3</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>

    <span class="n">visit</span> <span class="n">games_path</span>

    <span class="n">within</span><span class="p">(</span><span class="s2">&quot;table#games&quot;</span><span class="p">)</span> <span class="k">do</span>

      <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game1</span><span class="o">.</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game1</span><span class="o">.</span><span class="n">at</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game3</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game3</span><span class="o">.</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game3</span><span class="o">.</span><span class="n">at</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">game_user_created</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">games</span><span class="o">.</span><span class="n">last</span>

      <span class="n">page</span><span class="o">.</span><span class="n">save_and_open_page</span>

      <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game2</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game2</span><span class="o">.</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game2</span><span class="o">.</span><span class="n">at</span><span class="p">)</span>

    <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>Run the tests to see it failing (remember we haven&#39;t coded the controller or view yet)</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>


<span class="go">1) games listing games should display a list of the games the signed-in user is playing in</span>
<span class="go">    Failure/Error: within(&quot;table#games&quot;) do</span>
<span class="go">    Capybara::ElementNotFound:</span>
<span class="go">      Unable to find css &quot;table#games&quot;</span>
<span class="go">    # (eval):2:in `find&#39;</span>
<span class="go">    # ./spec/integration/games/restful_spec.rb:57:in `block (3 levels) in &lt;top (required)&gt;&#39;</span>
</pre></div>

<p>Let&#39;s add a variable to our <code>app/controllers/games\_controller.rb</code> index action to reference the games our signed-in user is playing in.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span>
 <span class="vi">@owned_games</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">owned_games</span>
 <span class="vi">@games</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">games</span>
<span class="k">end</span>
</pre></div>

<p>and add the games table to the view app/views/games/index.html.erb</p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Games</span><span class="c1">#index&lt;/h1&gt;</span>

<span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="no">Games</span> <span class="n">I</span> <span class="n">have</span> <span class="n">created</span><span class="o">&lt;</span><span class="sr">/h2&gt;</span>
<span class="sr">&lt;table id=&quot;owned_games&quot;&gt;</span>
<span class="sr">    &lt;% @owned_games.each do |game| %&gt;</span>
<span class="sr">    &lt;tr data-row=&#39;game_&lt;%= game.id %&gt;&#39;&gt;</span>
<span class="sr">        &lt;td&gt;&lt;%= game.sport.name %&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="sx">%= game.location %&gt;&lt;/td&gt;</span>
<span class="sx">        &lt;td&gt;&lt;%=</span> <span class="n">game</span><span class="o">.</span><span class="n">at</span> <span class="sx">%&gt;&lt;/td&gt;</span>
    <span class="o">&lt;</span><span class="sr">/tr&gt;</span>
<span class="sr">    &lt;% end %&gt;</span>
<span class="sr">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="no">Games</span> <span class="n">I</span> <span class="n">am</span> <span class="n">playing</span><span class="o">&lt;</span><span class="sr">/h2&gt;</span>
<span class="sr">&lt;table id=&quot;games&quot;&gt;</span>
<span class="sr">    &lt;% @games.each do |game| %&gt;</span>
<span class="sr">    &lt;tr data-row=&#39;game_&lt;%= game.id %&gt;&#39;&gt;</span>
<span class="sr">        &lt;td&gt;&lt;%= game.sport.name %&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="sx">%= game.location %&gt;&lt;/td&gt;</span>
<span class="sx">        &lt;td&gt;&lt;%=</span> <span class="n">game</span><span class="o">.</span><span class="n">at</span> <span class="sx">%&gt;&lt;/td&gt;</span>
    <span class="o">&lt;</span><span class="sr">/tr&gt;</span>
<span class="sr">    &lt;% end %&gt;</span>
<span class="sr">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
</pre></div>

<p>The tests should now pass.</p>

<p><a href="#top">back to top</a></p>

<h2><a id='creating-games'></a> 8.5. Creating Games</h2>

<p>If a user provides the correct information to create a new game we want to redirect them to the game&#39;s &#39;show&#39; page but if the information provided is invalid we return them to the &#39;new&#39; page where they can correct the information.</p>
<div class="highlight"><pre><span class="n">describe</span> <span class="s1">&#39;creating games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should create a new game when valid game parameters are provided and redirect&#39;</span>
    <span class="n">it</span> <span class="s1">&#39;should return users back to the new page with user input when incorrect parameters are provided&#39;</span>
<span class="k">end</span>
</pre></div>

<h3>8.5.1. it &#39;should create a new game when valid game parameters are provided and redirect to the show page&#39;</h3>

<p>To do this the spec must</p>

<ol>
<li>Journey to the new page by clicking a &#39;Create Game&#39; link from the index page.</li>
<li>Select a sport for our game from a drop-down.</li>
<li>Complete a text box for <code>game.location</code></li>
<li>Complete a rails <strong>date<em>time</em>select</strong> for <code>game.at</code></li>
</ol>

<p>A Rails date time select is a helper method that provides us with 5 drops down selects for year, month, day, hour and minute. In our case the selects for our <code>game.at</code> attribute will be called:</p>

<p>game[at(1i)]
game[at(2i)]
game[at(3i)]
game[at(4i)]
game[at(5i)]</p>

<p>ActiveRecord will automagically reassemble these five components back into a time for us.</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should create a new game when valid game parameters are provided and redirect to the show page&#39;</span> <span class="k">do</span>

    <span class="n">sport</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:sport</span><span class="p">)</span>

    <span class="n">visit</span> <span class="n">games_path</span>

    <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;Create Game&#39;</span><span class="p">)</span>

    <span class="n">fill_in</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;Wimbledon&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sport&quot;</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">3600</span> <span class="c1">#make it an hour from now</span>

    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(1i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="no">Date</span><span class="o">::</span><span class="no">MONTHNAMES</span><span class="o">[</span><span class="n">time</span><span class="o">.</span><span class="n">month</span><span class="o">]</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(2i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(3i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(4i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(5i)]&#39;</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">{</span>
     <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Create Game&#39;</span><span class="p">)</span>
    <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">{</span><span class="no">Game</span><span class="o">.</span><span class="n">count</span><span class="p">}</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">game_path</span><span class="p">(</span><span class="no">Game</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>

<span class="k">end</span>
</pre></div>

<p>I&#39;m pretty certain that we&#39;ll be using the exact same form in &#39;edit&#39; and &#39;new&#39; so we&#39;ll create the form as a partial. Create the file <code>app/views/games/_form.html.erb</code> and include this in our &#39;new&#39; view <code>app/views/games/hew.html.erb</code>. This will render <code>_form.html.erb</code> inside the view <code>new.html.erb</code></p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Games</span><span class="c1">#new&lt;/h1&gt;</span>

<span class="o">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;form&#39;</span> <span class="o">%&gt;</span>
</pre></div>

<p>Let&#39;s code the form.</p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="sx">%= form_for @game do |f| %&gt;</span>

<span class="sx">  &lt;div class=</span><span class="s2">&quot;control-group &lt;%= &quot;</span><span class="n">error</span><span class="s2">&quot; if @game.errors.any? %&gt;&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">%= f.label :sport_id, &#39;Sport&#39;, :class =</span><span class="o">&gt;</span> <span class="s1">&#39;control-label&#39;</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;div class=&#39;controls&#39;&gt;</span>
      <span class="o">&lt;</span><span class="sx">%= f.select :sport_id, options_from_collection_for_select(Sport.all, :id, :name), {:include_blank =</span><span class="o">&gt;</span> <span class="kp">true</span><span class="p">},</span> <span class="p">{</span><span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s1">&#39;input-xlarge&#39;</span> <span class="p">}</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;/div&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;</span>

<span class="sr">  &lt;div class=&quot;control-group &lt;%= &quot;error&quot; if @game.errors.any? %&gt;&quot;&gt;</span>
<span class="sr">    &lt;%= f.label :location, :class =&gt; &#39;control-label&#39; %&gt;</span>
<span class="sr">    &lt;div class=&#39;controls&#39;&gt;</span>
<span class="sr">      &lt;%= f.text_field :location, :class =&gt; &#39;input-xlarge&#39; %&gt;</span>
<span class="sr">    &lt;/</span><span class="n">div</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;</span>

<span class="sr">  &lt;div class=&quot;control-group &lt;%= &quot;error&quot; if @game.errors.any? %&gt;&quot;&gt;</span>
<span class="sr">    &lt;%= f.label :at, :class =&gt; &#39;control-label&#39; %&gt;</span>
<span class="sr">    &lt;div class=&#39;controls&#39;&gt;</span>
<span class="sr">      &lt;%= f.datetime_select &quot;at&quot;,{}, :class =&gt; &#39;input-small&#39; %&gt;</span>
<span class="sr">    &lt;/</span><span class="n">div</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;</span>

<span class="sr">  &lt;div class=&quot;form-actions&quot;&gt;</span>
<span class="sr">    &lt;%= f.submit @game.new_record? ? &#39;Create Game&#39; : &#39;Update Game&#39;, :class =&gt; &#39;btn btn-primary&#39; %&gt;</span>
<span class="sr">    &lt;%= link_to &#39;Back&#39;, games_path, :class =&gt; &#39;btn&#39; %&gt;</span>
<span class="sr">  &lt;/</span><span class="n">div</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</pre></div>

<ol>
<li>form_for @game understands that this is a new record. @game.new_record? == true because @game.id is nil. It creates a POST action rather than a PUT. When we get as far as editing an existing game then @game.new_record? == false because a game being edited will have an id. In this case form_for will make it a RESTFUL PUT action.</li>
<li><code>form_for @game do |f|</code> labels and controls are bound to @game via &#39;f&#39; e.g. <code>&lt;%= f.label :location, :class =&gt; &#39;control-label&#39; %&gt;  &lt;%= f.text_field :location, :class =&gt; &#39;input-xlarge&#39; %&gt;</code>. The :class arguments are simply TwitterBootstrap class names we want to appear in the html.</li>
<li>We&#39;ve bound the :sport<em>id to the select box &#39;Sport&#39; so that the parameter game[sport\</em>id] is submitted. If we&#39;d left it as sport then game[sport]=1 would imply we had a sport that was the number 1 and not a sport object with an id that is 1. </li>
<li><code>options_from_collection_for_select(Sport.all, :id, :name)</code> builds the select drop-down with an option for each sport in <code>Sport.all</code> using the sport <code>sport.id</code> and <code>sport.name</code> as the option value and text. </li>
</ol>

<p>That&#39;s our form, let&#39;s code the new and create action in <code>app/controllers/games_controller.rb</code>.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">create</span>
  <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:game</span><span class="o">]</span><span class="p">)</span>
  <span class="n">game</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">current_user</span>
  <span class="n">game</span><span class="o">.</span><span class="n">save</span>
  <span class="n">redirect_to</span> <span class="n">game</span><span class="p">\</span><span class="n">_path</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>In <code>def new</code> we instantiate an empty game object so that it can be bound to the controls in our _form.html.erb partial. </p>

<p>In <code>def create</code> we instantiate an empty object passing it params[:game]. Params[:game] is a hash containing all of the values submitted by our form that have game[:location], game[:sport_id]. A typical params hash is <code>{&quot;utf8&quot;=&gt;&quot;✓&quot;, &quot;game&quot;=&gt;{&quot;sport_id&quot;=&gt;&quot;1&quot;, &quot;location&quot;=&gt;&quot;Wimbledon&quot;, &quot;at(1i)&quot;=&gt;&quot;2012&quot;, &quot;at(2i)&quot;=&gt;&quot;9&quot;, &quot;at(3i)&quot;=&gt;&quot;22&quot;, &quot;at(4i)&quot;=&gt;&quot;16&quot;, &quot;at(5i)&quot;=&gt;&quot;15&quot;}, &quot;more_players&quot;=&gt;&quot;email&quot;, &quot;commit&quot;=&gt;&quot;Create Game&quot;, &quot;action&quot;=&gt;&quot;create&quot;, &quot;controller&quot;=&gt;&quot;games&quot;}</code>. Note the keys and values in the <code>&quot;game&quot; =&gt;</code> part of the hash.</p>

<p>A game needs an owner and that will always be the current user in our system so we set it.</p>

<p>We save the game and then redirect to the &#39;show&#39; page for that game. Save would have populated the <code>game.id</code> from the database so game_path(game) would be /games/123 for a game with id 123.</p>

<p>One last thing and this is a little ugly. Remember our form&#39;s sport control is bound to :sport_id and not :sport ? Well, when we come to create our game in the controller it will be updating :sport_id =&gt; 1 which means we have to make :sport_id attr_accessible as well as sport. If we don&#39;t we&#39;re going to get one of those <code>Can&#39;t mass-assign protected attributes: sport_id</code> errors when we save.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Game</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:sport</span><span class="p">,</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:sport</span><span class="p">\</span><span class="n">_id</span>

  <span class="n">validates</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:sport</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:players</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;users.email ASC&quot;</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:external_players</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;external_players.email ASC&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:sport</span>
  <span class="n">belongs_to</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span>

  <span class="k">def</span> <span class="nf">over?</span>
    <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">at</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>Let&#39;s run the tests, with our form and controller in place they should be passing:</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<h3>8.5.2. it &#39;should return users back to the new page with user input when incorrect parameters are provided&#39;</h3>

<p>This is similar to our previous test but, of course, we do something wrong so that when we submit our form the game is invalid. Let&#39;s submit a game that&#39;s in the past. We already have a helper method <code>game.over?</code> that we know will return true if the game is in the past so let&#39;s include that in a validation but ONLY if we&#39;re trying to create a new game NOT if we&#39;re trying to update something on an existing game.</p>

<p>We will add our own validation method to game. Before we do we&#39;d better go back to our spec/models/game_spec.rb and write a couple of additional tests for this validation. In <code>spec/models/game_spec.rb</code> add the two tests</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should not be valid if the game has not been saved and is in the past&#39;</span> <span class="k">do</span>
  <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:at</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="n">game</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:new</span><span class="p">\</span><span class="n">_record?</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">game</span><span class="o">.</span><span class="n">valid?</span>
  <span class="n">game</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="ss">:at</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;Cannot create a game in the past&quot;</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">it</span> <span class="s1">&#39;should be valid if the game has been saved and is in the past&#39;</span> <span class="k">do</span>
  <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:at</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="n">game</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:new</span><span class="p">\</span><span class="n">_record?</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
  <span class="n">game</span><span class="o">.</span><span class="n">valid?</span>
  <span class="n">game</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="ss">:at</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;Cannot create a game in the past&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>run the tests and see the first test fail.</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p>Note <code>game.stub(:new\_record?).and_return(false)</code>. Rather than manipulate test game ids so that we get new_record? to return the expected value we simply stub it out so that, for this one test, the game model returns the exact method we&#39;re looking for.</p>

<p>Let&#39;s create the validation in <code>models/game.rb</code>.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Game</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:sport</span><span class="p">,</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:sport_id</span>

  <span class="n">validates</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:sport</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:players</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;users.email ASC&quot;</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:external_players</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;external_players.email ASC&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:sport</span>
  <span class="n">belongs_to</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span>

  <span class="n">validate</span> <span class="ss">:cannot_create_a_game_in_the_past</span><span class="p">,</span> <span class="ss">:on</span> <span class="o">=&gt;</span> <span class="ss">:create</span>

  <span class="k">def</span> <span class="nf">over?</span>
    <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">at</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">cannot_create_a_game_in_the_past</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">at</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:at</span><span class="p">,</span> <span class="s1">&#39;Cannot create a game in the past&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">over?</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>We create a private method that checks to see if the game is in the past and call it with <code>validate :cannot_create_a_game_in_the_past, :on =&gt; :create</code>. The <code>:on =&gt; create</code> option means that the validation only runs when the object is new - in other words when <code>game.new_record?</code> is true. If it is in the past we add the desired error message against our :at attribute. So how do we make sure that the test object returns the desired true or false for <code>game.new_record?</code>. We could, for example, create an object, save it with the time at now then wait a few seconds to be sure it&#39;sin the past but that&#39;s clumsy. Instead we <code>game.stub(:new\_record?).and_return(false)</code> or true. Stub overrides the method <code>game.new_record?</code> for that one tests and returns true or false depending on what we specify in <code>.and_return</code>. It&#39;s simple and explicit.</p>

<p>Note that we had to put in the <code>return unless self.at</code> because the comparison would Time.now would fail if at is nil. This doesn&#39;t matter as a game with <code>at</code> is invalid anyway.</p>

<p>Now we know that we can&#39;t create a game in the past let&#39;s try and do that to make sure our form returns us back to the new page with the bad data we&#39;ve entered.</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should redirect users back to the new page with user input when incorrect parameters are provided&#39;</span> <span class="k">do</span>

    <span class="n">sport</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:sport</span><span class="p">)</span>

    <span class="n">visit</span> <span class="n">games_path</span>

    <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;Create Game&#39;</span><span class="p">)</span>

    <span class="n">fill_in</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;Wimbledon&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sport&quot;</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">3600</span> <span class="c1">#make it an hour in the past</span>

    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(1i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="no">Date</span><span class="o">::</span><span class="no">MONTHNAMES</span><span class="o">[</span><span class="n">time</span><span class="o">.</span><span class="n">month</span><span class="o">]</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(2i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(3i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(4i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(5i)]&#39;</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">{</span>
     <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Create Game&#39;</span><span class="p">)</span>
    <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">{</span><span class="no">Game</span><span class="o">.</span><span class="n">count</span><span class="p">}</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;Location&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Wimbledon&#39;</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;Sport&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;game[at(1i)]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;game[at(2i)]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="no">Date</span><span class="o">::</span><span class="no">MONTHNAMES</span><span class="o">[</span><span class="n">time</span><span class="o">.</span><span class="n">month</span><span class="o">]</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;game[at(3i)]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;game[at(4i)]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;game[at(5i)]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>

<span class="k">end</span>
</pre></div>

<p>So we try to create a game in the past, check that Game.count doesn&#39;t change so our attempt to create a game has failed, then check that the rendered page has the <code>game.sport</code>, <code>game.at</code> and <code>game.location</code> data we submitted.</p>

<p>We need to code the controller so that it handles invalid requests so let&#39;s update <code>def create</code> in our <code>app/controllers/games_controller.rb</code> so that it looks like this:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">GamesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="n">before_filter</span> <span class="ss">:authenticate_user!</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@owned_games</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">owned_games</span>
    <span class="vi">@games</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">games</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">current_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:game</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@game</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="k">if</span> <span class="vi">@game</span><span class="o">.</span><span class="n">save</span>
        <span class="n">redirect_to</span> <span class="n">game_path</span><span class="p">(</span><span class="vi">@game</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">render</span> <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s1">&#39;games/new.html.erb&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Note that we change game to @game so that it can be bound into the &#39;new&#39; form if the data is invalid. </p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>

<span class="go">Failures:</span>

<span class="go">  1) games creating games should redirect users back to the new page with user input when incorrect parameters are provided</span>
<span class="go">     Failure/Error: page.find_field(&#39;Sport&#39;).value.should have_content(sport.name)</span>
<span class="go">       expected there to be content &quot;sport7&quot; in &quot;&quot;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:134:in `block (3 levels) in &lt;top (required)&gt;&#39;</span>
</pre></div>

<p>Just one problem, it fails. Our drop down for sport hasn&#39;t selected the sport we chose <code>expected there to be content &quot;sport7&quot; in &quot;&quot;</code> and has displayed the first option which is blank. We can fix this in the form by updating the <code>options_from_collection_for_select(Sport.all, :id, :name)</code> so that the form looks like</p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="sx">%= form_for @game do |f| %&gt;</span>

<span class="sx">  &lt;div class=</span><span class="s2">&quot;control-group &lt;%= &quot;</span><span class="n">error</span><span class="s2">&quot; if @game.errors.any? %&gt;&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">%= f.label :sport_id, &#39;Sport&#39;, :class =</span><span class="o">&gt;</span> <span class="s1">&#39;control-label&#39;</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;div class=&#39;controls&#39;&gt;</span>
      <span class="o">&lt;</span><span class="sx">%= f.select :sport_id, options_from_collection_for_select(Sport.all, :id, :name, @game.sport.try(:id)), {:include_blank =</span><span class="o">&gt;</span> <span class="kp">true</span><span class="p">},</span> <span class="p">{</span><span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s1">&#39;input-xlarge&#39;</span> <span class="p">}</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;/div&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;</span>

<span class="sr">  &lt;div class=&quot;control-group &lt;%= &quot;error&quot; if @game.errors.any? %&gt;&quot;&gt;</span>
<span class="sr">    &lt;%= f.label :location, :class =&gt; &#39;control-label&#39; %&gt;</span>
<span class="sr">    &lt;div class=&#39;controls&#39;&gt;</span>
<span class="sr">      &lt;%= f.text_field :location, :class =&gt; &#39;input-xlarge&#39; %&gt;</span>
<span class="sr">    &lt;/</span><span class="n">div</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;</span>

<span class="sr">  &lt;div class=&quot;control-group &lt;%= &quot;error&quot; if @game.errors.any? %&gt;&quot;&gt;</span>
<span class="sr">    &lt;%= f.label :at, :class =&gt; &#39;control-label&#39; %&gt;</span>
<span class="sr">    &lt;div class=&#39;controls&#39;&gt;</span>
<span class="sr">      &lt;%= f.datetime_select &quot;at&quot;,{}, :class =&gt; &#39;input-small&#39; %&gt;</span>
<span class="sr">    &lt;/</span><span class="n">div</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;</span>

<span class="sr">  &lt;div class=&quot;control-group &lt;%= &quot;error&quot; if @game.errors.any? %&gt;&quot;&gt;</span>
<span class="sr">    &lt;%= f.label :players, :class =&gt; &#39;control-label&#39; %&gt;</span>
<span class="sr">    &lt;div class=&#39;controls&#39;&gt;</span>
<span class="sr">        &lt;% current_user.players.each do |player| %&gt;</span>
<span class="sr">            &lt;%= check_box_tag :player, player.id, @game.players.include?(player) %&gt; &lt;%= player.email %&gt;&lt;br/</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
<span class="sx">    &lt;/div&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;</span>

<span class="sr">  &lt;div class=&quot;control-group &lt;%= &quot;error&quot; if @game.errors.any? %&gt;&quot;&gt;</span>
<span class="sr">    &lt;%= f.label :players_not_on_stinky_trainers, :class =&gt; &#39;control-label&#39; %&gt;</span>
<span class="sr">    &lt;div class=&#39;controls&#39;&gt;</span>
<span class="sr">        &lt;% current_user.external_players.each do |player| %&gt;</span>
<span class="sr">            &lt;%= check_box_tag :external_player, player.id, @game.external_players.include?(player) %&gt; &lt;%= player.email %&gt;&lt;br/</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
<span class="sx">    &lt;/div&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;</span>

<span class="sr">  &lt;div class=&quot;control-group &lt;%= &quot;error&quot; if @game.errors.any? %&gt;&quot;&gt;</span>
<span class="sr">    &lt;%= f.label :more_players, :class =&gt; &#39;control-label&#39; %&gt;</span>
<span class="sr">    &lt;div class=&#39;controls&#39;&gt;</span>
<span class="sr">      &lt;%= text_field_tag :more_players, &#39;email&#39;, :class =&gt; &#39;input-xlarge&#39; %&gt;</span>
<span class="sr">    &lt;/</span><span class="n">div</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;</span>

<span class="sr">  &lt;div class=&quot;form-actions&quot;&gt;</span>
<span class="sr">    &lt;%= f.submit @game.new_record? ? &#39;Create Game&#39; : &#39;Update Game&#39;, :class =&gt; &#39;btn btn-primary&#39; %&gt;</span>
<span class="sr">    &lt;%= link_to &#39;Back&#39;, games_path, :class =&gt; &#39;btn&#39; %&gt;</span>
<span class="sr">  &lt;/</span><span class="n">div</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</pre></div>

<p>We&#39;ve added a third argument to <code>option\_from\_collection\_for\_select</code>, <code>@game.sport.try(:id)</code>. This third argument is the value we&#39;d like the select box to choose as selected (if it exists) but why the <code>sport.try(:id)</code> and not just <code>sport.id</code> ? Well, on a completely new game in our first test above sport will actually be nil so calling id on nil will raise an error. With <code>sport.try(:id)</code> Rails will try to get the value id from sport but return nil, rather than an error, if something goes wrong.</p>

<p>Run the tests and all should be passing</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<h3>8.5.3. What about the players and external_players?</h3>

<p>But what about the players ? I know I said that I want to be able to create a game without players but so far we can&#39;t add any even if we wanted to. I&#39;ve left this separate so far. The form we just created was complex enough and adding arrays of players makes it more so. I want to have my form list all of the players and external players that I know in an array of check boxes and this is one of those rare things that Rails doesn&#39;t handle seamlessly. As always there are several ways to do something but I&#39;ve chosen an approach that&#39;s reasonably easy to follow.</p>

<p>It&#39;s time for some tests. These aren&#39;t in my initial set of draft tests. We&#39;re agile so let&#39;s add these four new tests INSIDE of the <code>describe &#39;creating games&#39; do</code> block as the tests are associated with game creation</p>
<div class="highlight"><pre><span class="n">describe</span> <span class="s1">&#39;players&#39;</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s1">&#39;should display a list of check_boxes for the current users players in table#players with only the current user selected&#39;</span>

  <span class="n">it</span> <span class="s1">&#39;should display a list of check_boxes for the current users external\_players in table#players all unchecked&#39;</span> 

  <span class="n">it</span> <span class="s1">&#39;should submit a list of the selected players and add them to the game&#39;</span>

  <span class="n">it</span> <span class="s1">&#39;should submit a list of the selected external players and add them to the game&#39;</span>

<span class="k">end</span>
</pre></div>

<p>We&#39;re going to be building lists of players and external players using the <code>check_box_tag</code>. There are two groups of helpers for forms in Rails form_helpers and form_tag_helpers. We&#39;ve already used form_helpers, they&#39;re useful when we have an activerecord model in our form and they neatly bind the model to the form e.g.</p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="sx">% form_for </span><span class="vi">@game</span> <span class="sx">%&gt;</span>
<span class="sx">    f.text_field :location</span>
<span class="sx">    f.select :sport_id</span>
<span class="sx">&lt;% end %&gt;</span>
</pre></div>

<p>form_tag_helpers aren&#39;t bound to any objects at all so you would have <code>check_box_tag</code> rather than <code>f.check_box</code> they help us create html tags. We&#39;re going to use them in our form to create a checkbox for every player or external player that our user has shared a game with. How do we get a list of these ? Active record makes this easy for us.</p>

<p>Remember our user has a has_and_belongs_to_many relationship with games and a game has a has_and_belongs_to_many relationship with players and external_players ? Well ActiveRecord let&#39;s use these associations so that we can get all of the players and external players associated to our user via games. That&#39;s a lot to the think about so I&#39;ll just dive straight into the code. In <code>app/models/users/rb</code> add the two new associations <code>has_many :players, :through =&gt; :games, :uniq =&gt; true</code> and <code>has_many :external_players, :through =&gt; :games, :uniq =&gt; true</code> </p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Include default devise modules. Others available are:</span>
  <span class="c1"># :token_authenticatable, :confirmable,</span>
  <span class="c1"># :lockable, :timeoutable and :omniauthable</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span>

  <span class="c1"># Setup accessible (or protected) attributes for your model</span>
  <span class="n">attr_accessible</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">:remember_me</span>
  <span class="c1"># attr_accessible :title, :body</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:sports</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:games</span>

  <span class="n">has_many</span> <span class="ss">:players</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:games</span><span class="p">,</span> <span class="ss">:uniq</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">has_many</span> <span class="ss">:external_players</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:games</span><span class="p">,</span> <span class="ss">:uniq</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">has_many</span> <span class="ss">:owned_games</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Game&#39;</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="ss">:owner_id</span>
<span class="k">end</span>
</pre></div>

<p>Let&#39;s try this in console. </p>
<div class="highlight"><pre><span class="go">rails c</span>

<span class="gp">&gt;</span> <span class="nv">user</span> <span class="o">=</span> User.first

<span class="gp">&gt;</span> user.players

<span class="go">SELECT DISTINCT &quot;users&quot;.* FROM &quot;users&quot; INNER JOIN &quot;games_users&quot; ON &quot;users&quot;.&quot;id&quot; = &quot;games_users&quot;.&quot;user_id&quot; INNER JOIN &quot;games&quot; ON &quot;games_users&quot;.&quot;game_id&quot; = &quot;games&quot;.&quot;id&quot; INNER JOIN &quot;games_users&quot; &quot;games_players_join&quot; ON &quot;games&quot;.&quot;id&quot; = &quot;games_players_join&quot;.&quot;game_id&quot; WHERE &quot;games_players_join&quot;.&quot;user_id&quot; = 1</span>
</pre></div>

<p>Active record has joined <code>users</code> to <code>games\_users</code> to <code>games</code> and self-joined back to <code>games_users</code> to get us all the players our user has been associated with in a game. It self-joined because a player is a user.</p>
<div class="highlight"><pre><span class="gp">&gt;</span> user.external_players
<span class="go">SELECT DISTINCT &quot;external_players&quot;.* FROM &quot;external_players&quot; INNER JOIN &quot;external_players_games&quot; ON &quot;external_players&quot;.&quot;id&quot; = &quot;external_players_games&quot;.&quot;external_player_id&quot; INNER JOIN &quot;games&quot; ON &quot;external_players_games&quot;.&quot;game_id&quot; = &quot;games&quot;.&quot;id&quot; INNER JOIN &quot;games_users&quot; ON &quot;games&quot;.&quot;id&quot; = &quot;games_users&quot;.&quot;game_id&quot; WHERE &quot;games_users&quot;.&quot;user_id&quot; = 1</span>
</pre></div>

<p>Active record has joined <code>external_players</code> to <code>external_players_games</code> to <code>games</code> to <code>games_users</code> to get us all the external users our signed-in user is associated with via a game.</p>

<p>Glad I didn&#39;t have to do that by hand.</p>

<h3>8.5.4. it &#39;should display a list of check_boxes for the current users players in table#players with only the current user selected&#39;</h3>

<p>We want this test to ensure that we display a list of all the <code>user.players</code> associated with the signed-in user through games. Our signed-in user will be in this list and we want that user to be checked by default while all of the others are unchecked by default.</p>

<ol>
<li>Create four players</li>
<li>Create three games</li>
<li>Add the current user to the first two games.</li>
<li>Add players 1, 3 &amp; 4 to the first two games so they are associated with our signed-in user.</li>
<li>Add player2 to game3 so that it has no connection with our signed-in user.</li>
<li>Visit the index page and create a new game</li>
<li>Ensure that we have a checked checkbox for the signed-in user in the <code>&quot;div#players&quot;</code> control group.</li>
<li>Ensure that we have an unchecked checkbox for players 1, 3, 4 in the <code>&quot;div#players&quot;</code> control group.</li>
<li>Ensure that we don&#39;t have a checkbox for player2 in the <code>&quot;div#players&quot;</code> control group.</li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should display a list of check_boxes for the current users players in table#players with only the current user selected&#39;</span> <span class="k">do</span>

   <span class="n">player1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
   <span class="n">player2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
   <span class="n">player3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
   <span class="n">player4</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

   <span class="n">game1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
   <span class="n">game2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="n">player2</span><span class="p">)</span>
   <span class="n">game3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>

   <span class="n">game1</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>
   <span class="n">game2</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>

   <span class="n">game1</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player1</span>
   <span class="n">game2</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player3</span>
   <span class="n">game2</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player4</span>

   <span class="n">game3</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player2</span> <span class="c1">#a game created by a different user and player</span>

   <span class="n">visit</span> <span class="n">games_path</span>

   <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;Create Game&#39;</span><span class="p">)</span>

   <span class="n">within</span><span class="p">(</span><span class="s2">&quot;div#players&quot;</span><span class="p">)</span> <span class="k">do</span>
     <span class="n">page</span><span class="o">.</span><span class="n">has_field?</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
     <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>

     <span class="n">page</span><span class="o">.</span><span class="n">has_field?</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
     <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_checked</span>

     <span class="n">page</span><span class="o">.</span><span class="n">has_field?</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
     <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_checked</span>

     <span class="n">page</span><span class="o">.</span><span class="n">has_field?</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
     <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_checked</span>

     <span class="n">page</span><span class="o">.</span><span class="n">has_field?</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player2</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
   <span class="k">end</span>


<span class="k">end</span>
</pre></div>

<p>Let&#39;s add a control group that iterates through the signed-in user&#39;s players collection and creates a checkbox for each one.</p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;control-group &lt;%= &quot;</span><span class="n">error</span><span class="s2">&quot; if @game.errors.any? %&gt;&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">%= label_tag :players, nil, :class =</span><span class="o">&gt;</span> <span class="s1">&#39;control-label&#39;</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;div class=&#39;controls&#39; id=&quot;players&quot;&gt;</span>
        <span class="o">&lt;</span><span class="sx">% current_user.players.each </span><span class="k">do</span> <span class="o">|</span><span class="n">player</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">         &lt;%= check_box_tag &quot;game[player_ids][]&quot;, player.id, @game.players.include?(player), :id =&gt;</span> <span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="sx">%&gt; &lt;%= player.email %&gt;</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
<span class="sx">    &lt;/div&gt;</span>
<span class="o">&lt;</span><span class="sr">/div&gt;</span>
</pre></div>

<p><code>&lt;%= check_box_tag &quot;game[player_ids][]&quot;, player.id, @game.players.include?(player), :id =&gt; &quot;game_player_id_#{player.id}&quot; %&gt;</code> will produce html like <code>&lt;input id=&quot;game_player_id_1&quot; name=&quot;game[player_ids][]&quot; type=&quot;checkbox&quot; value=&quot;1&quot;&gt;</code> and we ensure the existance and checked-state for these in our tests above e.g.:</p>
<div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">has_field?</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
<span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_checked</span>
</pre></div>

<p>The test should now pass:</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<h3>8.5.5. it &#39;should display a list of check<em>boxes for the current users external\</em>players in table#players all unchecked&#39;</h3>

<p>We want this test to ensure that we display a list of all the <code>user.external_players</code> associated with the signed-in user through games. They should all be unchecked.</p>

<ol>
<li>We create four players. </li>
<li>We create three games.</li>
<li>We add our sign-in user and players 1, 3 and 4 to games so that they are associated with each other</li>
<li>We add player2 to a game owned by another user so player 2 won&#39;t be associated with the signed-in user.</li>
<li>We visit the index page, click &#39;Create Game&#39; and make sure that we have an unchecked checkbox for players 1, 3 and 4 in the <code>div#external_players</code> control-group. </li>
<li>We make sure we don&#39;t have player 2 in the <code>div#external_players</code> control group.</li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should display a list of check_boxes for the current users external\_players in table#players all unchecked&#39;</span> <span class="k">do</span>

   <span class="n">player1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>
   <span class="n">player2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>
   <span class="n">player3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>
   <span class="n">player4</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>

   <span class="n">game1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
   <span class="n">game2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="n">player4</span><span class="p">)</span>
   <span class="n">game3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>

   <span class="n">game1</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>
   <span class="n">game2</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>

   <span class="n">game1</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player1</span>
   <span class="n">game2</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player3</span>
   <span class="n">game2</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player4</span>

   <span class="n">game3</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player2</span>

   <span class="n">visit</span> <span class="n">games_path</span>

   <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;Create Game&#39;</span><span class="p">)</span>

   <span class="n">within</span><span class="p">(</span><span class="s2">&quot;div#external_players&quot;</span><span class="p">)</span> <span class="k">do</span>

     <span class="n">page</span><span class="o">.</span><span class="n">has_field?</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
     <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_external_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_checked</span>

     <span class="n">page</span><span class="o">.</span><span class="n">has_field?</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
     <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_external_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_checked</span>

     <span class="n">page</span><span class="o">.</span><span class="n">has_field?</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
     <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_external_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_checked</span>

     <span class="n">page</span><span class="o">.</span><span class="n">has_field?</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player2</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
   <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>Let&#39;s add a control group that iterates through the signed-in user&#39;s external_players collection and creates a checkbox for each one.</p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;control-group &lt;%= &quot;</span><span class="n">error</span><span class="s2">&quot; if @game.errors.any? %&gt;&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">%= label\_tag :players\_not\_on\_stinky\_trainers, nil, :class =</span><span class="o">&gt;</span> <span class="s1">&#39;control-label&#39;</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;div class=&#39;controls&#39; id=&quot;external_players&quot;&gt;</span>
        <span class="o">&lt;</span><span class="sx">% current_user.external_players.each </span><span class="k">do</span> <span class="o">|</span><span class="n">external_player</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">            &lt;%= check_box_tag &quot;game[external_player_ids][]&quot;, external_player.id, @game.external_players.include?(external_player), :id =&gt;</span> <span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">external_player</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="sx">%&gt; &lt;%= external_player.email %&gt;</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
<span class="sx">    &lt;/div&gt;</span>
<span class="o">&lt;</span><span class="sr">/div&gt;</span>
</pre></div>

<p>The test should now pass</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<h3>8.5.6. it &#39;should submit a list of the selected players and add them to the game&#39;</h3>

<p>When the form is submitted we want Rails to add all of the players that have been checked in the players list to be added to the <code>game.players</code> association.</p>

<ol>
<li>Create 3 players</li>
<li>Create a game, add the three players and our signed-in user. This isn&#39;t the game in our form but one that&#39;s already created &amp; ensures that they are associated with our signed-in user.</li>
<li>Visit the index page and click &#39;Create Game&#39;</li>
<li>Fill in the game details making our location a Guid.</li>
<li>Uncheck our signed-in user from the list of players and select players 1 and 3</li>
<li>Submit the form</li>
<li>Find the game we just created using our unique Guid location.</li>
<li>Ensure that the <code>game.players =~ [player1, player3]</code> Note that =~ is an RSpec way of comparing two arrays whilst ignoring the order of that Array.</li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should submit a list of the selected players and add them to the game&#39;</span> <span class="k">do</span>

     <span class="n">sport</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:sport</span><span class="p">)</span>

     <span class="n">player1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
     <span class="n">player2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
     <span class="n">player3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

     <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>

     <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>

     <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player1</span>
     <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player2</span>
     <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player3</span>

     <span class="n">visit</span> <span class="n">games_path</span>

     <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;Create Game&#39;</span><span class="p">)</span>

     <span class="n">unique_location</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">uuid</span>

     <span class="n">fill_in</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">unique_location</span><span class="p">)</span>
     <span class="nb">select</span><span class="p">(</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sport&quot;</span><span class="p">)</span>

     <span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">3600</span> 

     <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(1i)]&#39;</span><span class="p">)</span>
     <span class="nb">select</span><span class="p">(</span><span class="no">Date</span><span class="o">::</span><span class="no">MONTHNAMES</span><span class="o">[</span><span class="n">time</span><span class="o">.</span><span class="n">month</span><span class="o">]</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(2i)]&#39;</span><span class="p">)</span>
     <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(3i)]&#39;</span><span class="p">)</span>
     <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(4i)]&#39;</span><span class="p">)</span>
     <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(5i)]&#39;</span><span class="p">)</span>

     <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
     <span class="n">check</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
     <span class="n">check</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

     <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Create Game&#39;</span><span class="p">)</span>

     <span class="n">created_game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">find_by_location</span><span class="p">(</span><span class="n">unique_location</span><span class="p">)</span>

     <span class="n">created_game</span><span class="o">.</span><span class="n">players</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="o">[</span><span class="n">player1</span><span class="p">,</span> <span class="n">player3</span><span class="o">]</span>

<span class="k">end</span>
</pre></div>

<p>ActiveRecord has built-in functionality for adding these list of players to our game so we don&#39;t have to do that much. When the form is submitted, the parameters for game are passed to the controller as below:</p>
<div class="highlight"><pre><span class="go">&quot;game&quot;=&gt;{&quot;sport\_id&quot;=&gt;&quot;8&quot;, &quot;location&quot;=&gt;&quot;wembley&quot;, &quot;at(1i)&quot;=&gt;&quot;2012&quot;, &quot;at(2i)&quot;=&gt;&quot;9&quot;, &quot;at(3i)&quot;=&gt;&quot;23&quot;, &quot;at(4i)&quot;=&gt;&quot;14&quot;, &quot;at(5i)&quot;=&gt;&quot;34&quot;, &quot;player\_ids&quot;=&gt;[&quot;1&quot;,&quot;3&quot;,&quot;7&quot;]}</span>
</pre></div>

<p>ActiveRecord automatically sets the game&#39;s players as players with id 1, 3 and 7 and all our has to do is do what it&#39;s already doing <code>Game.new(params[:game])</code>. ActiveRecord is smart enough to understand that player_ids array is an array of ids for the players association.</p>

<p>There is one bit of code we must change to make all this work. We need to set our game class to accept the attributes player_ids or we&#39;ll get a pesky <code>can&#39;t mass-assign attributes</code> error. Add the player_ids assignment to <code>attr_accessible</code> in <code>app/models/game.rb</code>.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Game</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr</span><span class="p">\</span><span class="n">_accessible</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:sport</span><span class="p">,</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:sport</span><span class="p">\</span><span class="n">_id</span><span class="p">,</span> <span class="ss">:player</span><span class="p">\</span><span class="n">_ids</span>

  <span class="n">validates</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:sport</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:players</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;users.email ASC&quot;</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:external_players</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;external_players.email ASC&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:sport</span>
  <span class="n">belongs_to</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span>

  <span class="n">validate</span> <span class="ss">:cannot_create_a_game_in_the_past</span><span class="p">,</span> <span class="ss">:on</span> <span class="o">=&gt;</span> <span class="ss">:create</span>

  <span class="k">def</span> <span class="nf">over?</span>
    <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">at</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">cannot_create_a_game_in_the_past</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">at</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:at</span><span class="p">,</span> <span class="s1">&#39;Cannot create a game in the past&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">over?</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<h3>8.5.7. it &#39;should submit a list of the selected external players and add them to the game&#39;</h3>

<p>When the form is submitted we want Rails to add all of the players that have been checked in the players list to be added to the <code>game.external_players</code> association.</p>

<ol>
<li>Create 3 external players</li>
<li>Create a game, add the three players and our signed-in user. Again, this isn&#39;t the game in our form but one that&#39;s already created to ensure that the external players are associated with our signed-in user.</li>
<li>Visit the index page and click &#39;Create Game&#39;</li>
<li>Fill in the game details making our location a Guid.</li>
<li>Select external players 1 and 3 </li>
<li>Submit the form</li>
<li>Find the game we just created using our unique Guid location.</li>
<li>Ensure that the <code>game.players =~ [player1, player3]</code> Note that =~ is an RSpec way of comparing two arrays whilst ignoring the order of that Array. </li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should submit a list of the selected external players and add them to the game&#39;</span> <span class="k">do</span>

    <span class="n">sport</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:sport</span><span class="p">)</span>

    <span class="n">player1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>
    <span class="n">player2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>
    <span class="n">player3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>

    <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>

    <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>

    <span class="n">game</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player1</span>
    <span class="n">game</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player2</span>
    <span class="n">game</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player3</span>

    <span class="n">visit</span> <span class="n">games_path</span>

    <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;Create Game&#39;</span><span class="p">)</span>

    <span class="n">unique_location</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">uuid</span>

    <span class="n">fill_in</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">unique_location</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sport&quot;</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">3600</span> 

    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(1i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="no">Date</span><span class="o">::</span><span class="no">MONTHNAMES</span><span class="o">[</span><span class="n">time</span><span class="o">.</span><span class="n">month</span><span class="o">]</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(2i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(3i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(4i)]&#39;</span><span class="p">)</span>
    <span class="nb">select</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s1">&#39;game[at(5i)]&#39;</span><span class="p">)</span>


    <span class="n">check</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">check</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Create Game&#39;</span><span class="p">)</span>

    <span class="n">created_game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">find_by_location</span><span class="p">(</span><span class="n">unique_location</span><span class="p">)</span>

    <span class="n">created_game</span><span class="o">.</span><span class="n">external_players</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="o">[</span><span class="n">player1</span><span class="p">,</span> <span class="n">player3</span><span class="o">]</span>

<span class="k">end</span>
</pre></div>

<p>This is very similar to adding players above. Again ActiveRecord has built-in functionality for adding these list of players to our game so we don&#39;t have to do that much. When the form is submitted, the parameters for game are passed to the controller as below:</p>
<div class="highlight"><pre><span class="go">&quot;game&quot;=&gt;{&quot;sport\_id&quot;=&gt;&quot;8&quot;, &quot;location&quot;=&gt;&quot;wembley&quot;, &quot;at(1i)&quot;=&gt;&quot;2012&quot;, &quot;at(2i)&quot;=&gt;&quot;9&quot;, &quot;at(3i)&quot;=&gt;&quot;23&quot;, &quot;at(4i)&quot;=&gt;&quot;14&quot;, &quot;at(5i)&quot;=&gt;&quot;34&quot;, &quot;external_player\_ids&quot;=&gt;[&quot;1&quot;,&quot;3&quot;]}</span>
</pre></div>

<p>ActiveRecord automatically sets the game&#39;s players as players with id 1 &amp; 3 and all our has to do is do what it&#39;s already doing <code>Game.new(params[:game])</code>. ActiveRecord is smart enough to understand that external_player_ids array is an array of ids for the players association.</p>

<p>Again there is one bit of code we must change to make all this work. We need to set our game class to accept the attributes external_player_ids or we&#39;ll get the <code>can&#39;t mass-assign attributes</code> error. Add the external_player_ids assignment to <code>attr_accessible</code> in <code>app/models/game.rb</code>.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Game</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:sport</span><span class="p">,</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:sport_id</span><span class="p">,</span> <span class="ss">:player_ids</span><span class="p">,</span> <span class="ss">:external_player_ids</span>

  <span class="n">validates</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:at</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:sport</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:players</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;users.email ASC&quot;</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:external_players</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;external_players.email ASC&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:sport</span>
  <span class="n">belongs_to</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span>

  <span class="n">validate</span> <span class="ss">:cannot_create_a_game_in_the_past</span><span class="p">,</span> <span class="ss">:on</span> <span class="o">=&gt;</span> <span class="ss">:create</span>

  <span class="k">def</span> <span class="nf">over?</span>
    <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">at</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">cannot_create_a_game_in_the_past</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">at</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:at</span><span class="p">,</span> <span class="s1">&#39;Cannot create a game in the past&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">over?</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<h3>8.5.8. Adding a new player</h3>

<p>Lastly we need to be able to add a new player that we haven&#39;t played with before. We&#39;ll just add a textfield where the user can add an email address. When the form is submitted then we use the email to find an existing player (User) or an existing external_player. If we don&#39;t find either then we create a new external player and add it to the game. </p>

<p>Let&#39;s write some draft tests:</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should add a player where the email matches an existing user&#39;</span>
<span class="n">it</span> <span class="s1">&#39;should add an external player where the email doesn&#39;</span><span class="n">t</span> <span class="n">match</span> <span class="n">an</span> <span class="n">existing</span> <span class="n">user</span> <span class="n">but</span> <span class="n">matches</span> <span class="n">an</span> <span class="n">existing</span> <span class="no">External</span> <span class="no">Player</span>
<span class="n">it</span> <span class="s1">&#39;should create and add an external player where the email doesn&#39;</span><span class="n">t</span> <span class="n">match</span> <span class="n">an</span> <span class="n">existing</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">external</span> <span class="n">player</span><span class="err">&#39;</span> 
</pre></div>

<p>Before we start with our integration tests, there&#39;s a little bit of business logic going on here and I don&#39;t want to put it into our controller so we;re going to go back and add a method to the Game class <code>add_new_player</code> that accepts an email as an argument then looks for a User with that email, an External Player with that email or otherwise creates an ExternalPlayer.</p>

<p>Let&#39;s write some tests in <code>spec/models/game_spec.rb</code></p>

<p>ruby~~~
it &#39;should add a user to players if a user with the email exists&#39;
it &#39;should add an external player to external players if an external player with the email exists&#39;
it &#39;should create an external player and add it to external players if no user or external player exists&#39;
~~~</p>

<h4>it &#39;should add a user to players if a user with the email exists&#39;</h4>

<p>Let&#39;s write a test for our game model that:</p>

<ol>
<li>creates a game</li>
<li>creates a user</li>
<li>calls <code>add_new_player</code> on game with the email of the user we created</li>
<li>checks that the user has been added to game.</li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should add a user to players if a user with the email exists&#39;</span> <span class="k">do</span>
  <span class="n">player</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
  <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">)</span>
  <span class="n">game</span><span class="o">.</span><span class="n">add</span><span class="p">\</span><span class="n">_new</span><span class="p">\</span><span class="n">_player</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
  <span class="n">game</span><span class="o">.</span><span class="n">players</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">player</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>

<p>To get the test passing we need to code the game.add_new_player(email) method. In our <code>models/game.rb</code> class add this code:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">add</span><span class="p">\</span><span class="n">_new</span><span class="p">\</span><span class="n">_player</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">player</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">))</span>
      <span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player</span>
      <span class="k">return</span>
    <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>the test should now pass</p>
<div class="highlight"><pre><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">spec</span>
</pre></div>

<h4>it &#39;should add a user to players if a user with the email exists&#39;</h4>

<p>This test is similar to our previous one.</p>

<ol>
<li>creates a game</li>
<li>creates an external player</li>
<li>calls <code>add_new_player</code> on game with the email of the external player we created</li>
<li>checks that the external has been added to game.</li>
</ol>

<p>it &#39;should add a user to players if a user with the email exists&#39; do
  external<em>player = FactoryGirl.create(:external</em>player)
  game = FactoryGirl.create(:game)
  game.add<em>new</em>player(external<em>player.email)
  game.external</em>players.should == [external_player]
end</p>

<p>To get the test passing we need to extend the code in game.add_new_player(email). Add the <code>if (player = ExternalPlayer.find_by_email(email))</code> code block to <code>app/models/game.rb</code></p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">add</span><span class="p">\</span><span class="n">_new</span><span class="p">\</span><span class="n">_player</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">player</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">))</span>
      <span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player</span>
      <span class="k">return</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">player</span> <span class="o">=</span> <span class="no">ExternalPlayer</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">))</span>
      <span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player</span>
      <span class="k">return</span>
    <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>the test should now pass</p>
<div class="highlight"><pre><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">spec</span>
</pre></div>

<h4>it &#39;should create an external player and add it to external players if no user or external player exists&#39;</h4>

<p>This test expects us to create and add an external player when we provide an email that doesn&#39;t exists.</p>

<ol>
<li>Create a game</li>
<li>Call <code>game.add_new_player</code> with an email that doesn&#39;t exist as a user or external player. We won&#39;t create any users or external players so it&#39;s safe to assume this email doesn&#39;t exists.</li>
<li>Wrap the call to <code>game.add_new_player</code> in a block that expects us to increase the number of external players by 1.</li>
<li>Find the newly created external player and ensure that the game has this player in its external players collection.</li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should create an external player and add it to external players if no user or external player exists&#39;</span> <span class="k">do</span>
    <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">{</span>
     <span class="n">game</span><span class="o">.</span><span class="n">add_new_player</span><span class="p">(</span><span class="s1">&#39;test@testxyz.co.xy&#39;</span><span class="p">)</span>
    <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">{</span><span class="no">ExternalPlayer</span><span class="o">.</span><span class="n">count</span><span class="p">}</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">external_player</span> <span class="o">=</span> <span class="no">ExternalPlayer</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s1">&#39;test@testxyz.co.xy&#39;</span><span class="p">)</span>
    <span class="n">game</span><span class="o">.</span><span class="n">external_players</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">external_player</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>

<p>To get the test passing we need to extend the code in game.add_new_player(email) once again. Add the line <code>external_players.create!(:email =&gt; email)</code> to <code>app/models/game.rb</code></p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">add</span><span class="p">\</span><span class="n">_new</span><span class="p">\</span><span class="n">_player</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">player</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">))</span>
      <span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player</span>
      <span class="k">return</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">player</span> <span class="o">=</span> <span class="no">ExternalPlayer</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">))</span>
      <span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player</span>
      <span class="k">return</span>
    <span class="k">end</span>

    <span class="n">external_players</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">)</span>

<span class="k">end</span>
</pre></div>

<p>the test should now pass</p>
<div class="highlight"><pre><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">spec</span>
</pre></div>

<h3>8.5.9. it &#39;should add a player where the email matches an existing user&#39;</h3>

<p>So that&#39;s the additional logic to our game model written and tested. Now we can return to our integration tests for the game controller. From above they were:</p>
<div class="highlight"><pre> <span class="n">it</span> <span class="s1">&#39;should add a player where the email matches an existing user&#39;</span>
 <span class="n">it</span> <span class="s1">&#39;should add an external player where the email doesn&#39;</span><span class="n">t</span> <span class="n">match</span> <span class="n">an</span> <span class="n">existing</span> <span class="n">user</span> <span class="n">but</span> <span class="n">matches</span> <span class="n">an</span> <span class="n">existing</span> <span class="no">External</span> <span class="no">Player</span>
 <span class="n">it</span> <span class="s1">&#39;should create and add an external player where the email doesn&#39;</span><span class="n">t</span> <span class="n">match</span> <span class="n">an</span> <span class="n">existing</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">external</span> <span class="n">player</span><span class="err">&#39;</span> 
</pre></div>

<p>Hmmm, they look very similar to the three model tests we just wrote. Because we pushed the logic into the model and out of the controller, our controller tests are now just doing the same thing as our model tests. In each of these three integration tests our controller would be calling the same line of code <code>@game.add_new_player(email)</code>. So, I&#39;m going to scrap these tests - which is good model tests are always more succinct than integration tests - and replace them by two simpler integration tests:</p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should call add\_new\_player&#39;</span> <span class="n">on</span> <span class="n">creating</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">game</span> <span class="k">when</span> <span class="n">a</span> <span class="kp">new</span> <span class="n">player</span> <span class="n">email</span> <span class="n">is</span> <span class="n">provided</span><span class="s1">&#39;</span>
<span class="s1">it &#39;</span><span class="n">should</span> <span class="ow">not</span> <span class="n">call</span> <span class="n">add</span><span class="p">\</span><span class="n">_new</span><span class="p">\</span><span class="n">_player</span><span class="s1">&#39; on creating a valid game when no new player email is provided&#39;</span>  
<span class="n">it</span> <span class="s1">&#39;should not call add\_new\_player&#39;</span> <span class="n">on</span> <span class="n">creating</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">game</span> <span class="k">when</span> <span class="n">a</span> <span class="kp">new</span> <span class="n">player</span> <span class="n">email</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">provided</span><span class="err">&#39;</span>
</pre></div>

<h4>it &#39;should call add_new_player&#39; on creating a valid game when a new player email is provided&#39;</h4>

<p>A slight confession before we write the three above tests. They&#39;re not integration tests, they&#39;re controller tests we said earlier that we weren&#39;t going to do. What makes it a controller test and not an integration test ? If you look at the the three draft tests above, they all require a method to be called (or not called) inside of the controller. Integration test generally emulate the user experience while controller &amp; view tests define what the application is doing under the hood. We could, of course, write the draft integration tests we intially envisaged even though they pretty much shadow our model tests for <code>game.add_new_player</code> but we&#39;re here to learn and this is a good opportunity to do a little old-school controller testing.</p>

<p>If it doesn&#39;t exists, create a file spec/controllers/games<em>controller</em>spec.rb with the code</p>
<div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">GamesController</span> <span class="k">do</span>

<span class="k">end</span>
</pre></div>

<p>Let&#39;s write a test for our games controller that makes sure add_new_player get&#39;s called for a valid game and when a new player email is provided.</p>

<ol>
<li>We sign_in a user </li>
<li>We create an instance of game with FactoryGirl and set an expectation on that instance that add_new_player will be called once with the email address &#39;test@yxz.wx.yz&#39; <code>game.should_receive(:add_new_player).with(&#39;test@yxz.wx.yz&#39;)</code></li>
<li>We also stub our instance of game so that it returns true when we call <code>@game.save</code>. This simulates the game being valid and saves us providing lots of parameters we don&#39;t need. All we do is provide the arbitrary string &#39;game params&#39;.</li>
<li>Then - and this isn&#39;t pretty - we have to stub Game.new so that it returns the instance of game we&#39;ve already set expectations and stubs on; unlike model specs, all this code is running inside the controller, not our test so if we don&#39;t stub Game.new it will just create a new game instance inside the controller and our FactoryGirl instance will never be used.</li>
<li>Lastly we call <code>post create</code> to call the action on our controller passing it the new_player and game params.</li>
</ol>
<div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">GamesController</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s1">&#39;should call add_new_player on creating a valid game when a new player email is provided&#39;</span> <span class="k">do</span>

      <span class="n">sign_in</span> <span class="ss">:user</span><span class="p">,</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

      <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">)</span>
      <span class="n">game</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:add_new_player</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s1">&#39;test@yxz.wx.yz&#39;</span><span class="p">)</span>
      <span class="n">game</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:save</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
      <span class="no">Game</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s1">&#39;game params&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

      <span class="n">post</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="ss">:new_player</span> <span class="o">=&gt;</span> <span class="s1">&#39;test@yxz.wx.yz&#39;</span><span class="p">,</span> <span class="ss">:game</span> <span class="o">=&gt;</span> <span class="s1">&#39;game params&#39;</span>

  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>To get this test passing we need some code in our games controllers create method</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:game</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@game</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="vi">@game</span><span class="o">.</span><span class="n">add</span><span class="p">\</span><span class="n">_new</span><span class="p">\</span><span class="n">_player</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:new</span><span class="p">\</span><span class="n">_player</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@game</span><span class="o">.</span><span class="n">save</span>
        <span class="n">redirect</span><span class="p">\</span><span class="n">_to</span> <span class="n">game</span><span class="p">\</span><span class="n">_path</span><span class="p">(</span><span class="vi">@game</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">render</span> <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s1">&#39;games/new.html.erb&#39;</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>The test should now pass:</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<h4>it &#39;should not call add_new_player on creating a valid game when a &#39;new player&#39; email is not provided&#39;</h4>

<p>This test is the opposite of our previous test and also a controller test except this time we don&#39;t provide the new_player parameter and expect that add_new_player is never called - <code>game.should_receive(:add_new_player).with(anything).never</code></p>

<ol>
<li>We sign_in a user </li>
<li>We create an instance of game with FactoryGirl and set an expectation on that instance that add_new_player will never be called.</li>
<li>We also stub our instance of game so that it returns true when we call <code>@game.save</code>. This simulates the game being valid and saves us providing lots of parameters we don&#39;t need. All we do is provide the arbitrary string &#39;game params&#39;.</li>
<li>Once again we have to stub Game.new so that it returns the instance of game we&#39;ve already set expectations and stubs on; unlike model specs, all this code is running inside the controller, not our test so if we don&#39;t stub Game.new it will just create a new game instance inside the controller and our FactoryGirl instance will never be used.</li>
<li>Lastly we call <code>post create</code> but this time don&#39;t pass the new_player params.</li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should not call add\_new\_player on creating a valid game when a new player email is not provided&#39;</span> <span class="k">do</span>

    <span class="n">sign_in</span> <span class="ss">:user</span><span class="p">,</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

    <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">)</span>
    <span class="n">game</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:save</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="n">game</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:add_new_player</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="n">anything</span><span class="p">)</span><span class="o">.</span><span class="n">never</span>
    <span class="no">Game</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s1">&#39;game params&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

    <span class="n">post</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="ss">:game</span> <span class="o">=&gt;</span> <span class="s1">&#39;game params&#39;</span>

<span class="k">end</span>
</pre></div>

<p>to get this test working we have to add a condition <code>unless params[:new_player].blank?</code> to the line of code we added in the previous test in <code>app/controllers/games_controller.rb</code></p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:game</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@game</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="vi">@game</span><span class="o">.</span><span class="n">add_new_player</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:new</span><span class="p">\</span><span class="n">_player</span><span class="o">]</span><span class="p">)</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="ss">:new_player</span><span class="o">].</span><span class="n">blank?</span>
    <span class="k">if</span> <span class="vi">@game</span><span class="o">.</span><span class="n">save</span>
        <span class="n">redirect_to</span> <span class="n">game_path</span><span class="p">(</span><span class="vi">@game</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">render</span> <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s1">&#39;games/new.html.erb&#39;</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>The test should now pass:</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<h4>it &#39;should not call add_new_player on creating an invalid game even when a new player email is provided&#39;</h4>

<p>This is the last controller spec test for the time being. We don&#39;t want <code>game.add_new_player</code> to be called if the game isn&#39;t valid.</p>

<ol>
<li>We sign_in a user </li>
<li>We create an instance of game with FactoryGirl and set an expectation on that instance that add_new_player will never be called.</li>
<li>We also stub our instance of game so that it returns false when we call <code>@game.save</code>. This simulates the game being invalid.</li>
<li>Once again we have to stub Game.new so that it returns the instance of game we&#39;ve already set expectations and stubs on; unlike model specs, all this code is running inside the controller, not our test so if we don&#39;t stub Game.new it will just create a new game instance inside the controller and our FactoryGirl instance will never be used.</li>
<li>Lastly we call <code>post create</code> to call the action on our controller passing it the new_player and game params.</li>
</ol>

<p>Still in <code>spec/controllers/games_controller_spec.rb</code></p>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should not call add\_new\_player on creating an invalid game even when a new player email is provided&#39;</span> <span class="k">do</span>

    <span class="n">sign_in</span> <span class="ss">:user</span><span class="p">,</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

    <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">)</span>
    <span class="n">game</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:save</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
    <span class="n">game</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:add_new_player</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s1">&#39;test@yxz.wx.yz&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">never</span>
    <span class="no">Game</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s1">&#39;game params&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

    <span class="n">post</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="ss">:new_player</span> <span class="o">=&gt;</span> <span class="s1">&#39;test@yxz.wx.yz&#39;</span><span class="p">,</span> <span class="ss">:game</span> <span class="o">=&gt;</span> <span class="s1">&#39;game params&#39;</span>

<span class="k">end</span>
</pre></div>

<p>To get this test passing we just move our <code>add_new_player</code> code inside the <code>if @game.save</code> block so that it only gets called when the game is successfully saved. This brings us onto an interesting point about ActiveRecord associations. If the object has been saved to the database, the association gets created as soon as you add something to it. You don&#39;t have to call <code>game.save</code> again.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">create</span>
  <span class="vi">@game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:game</span><span class="o">]</span><span class="p">)</span>
  <span class="vi">@game</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">current_user</span>

  <span class="k">if</span> <span class="vi">@game</span><span class="o">.</span><span class="n">save</span>
    <span class="vi">@game</span><span class="o">.</span><span class="n">add_new_player</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:new_player</span><span class="o">]</span><span class="p">)</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="ss">:new_player</span><span class="o">].</span><span class="n">blank?</span>
    <span class="n">redirect_to</span> <span class="n">game_path</span><span class="p">(</span><span class="vi">@game</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="n">render</span> <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s1">&#39;games/new.html.erb&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>The test should now pass:</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p>That&#39;ll be the end of our controller specs for the time being. They served a purpose - and sometimes they are the best solution - but I&#39;m pretty sure you&#39;ll agree that they don&#39;t feel quite as relevant as integration tests particularly since we have to mock and stub so many things to get them working.</p>

<p><a href="#top">back to top</a></p>

<h2><a id='testing-the-edit-updates-actions'></a> 8.6. Testing the edit/updates actions</h2>

<p>This will be similar to the test for new/create except that in each case we&#39;ll create the game first with FactoryGirl then edit it.</p>

<h3>8.6.1. it &#39;should update a valid game and redirect to the show page&#39;</h3>

<p>We&#39;ll create a game with FactoryGirl, change the time, submit it, navigate back to the edit screen and make sure our new values are there.</p>

<ol>
<li>Create a game with a unique location Guid.</li>
<li>Visit the index page</li>
<li>Click the edit link for our game</li>
<li>Ensure we are on the edit page</li>
<li>Check the details in the form are the same as those in the game we created</li>
<li>Move the game on by a year</li>
<li>Click the &#39;Update Game&#39; button</li>
<li>Find the game using it&#39;s unique location Guid and make sure the year has been updated.</li>
</ol>
<div class="highlight"><pre><span class="n">describe</span> <span class="s1">&#39;editing games&#39;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s1">&#39;should update a valid game and redirect to the show page&#39;</span> <span class="k">do</span>

      <span class="n">unique_location</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">uuid</span>

      <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:location</span> <span class="o">=&gt;</span> <span class="n">unique_location</span><span class="p">)</span>

      <span class="n">visit</span> <span class="n">games_path</span>

      <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
          <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">edit_game_path</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

      <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;Location&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
      <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;Sport&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;game[at(1i)]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">at</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
      <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;game[at(2i)]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="no">Date</span><span class="o">::</span><span class="no">MONTHNAMES</span><span class="o">[</span><span class="n">game</span><span class="o">.</span><span class="n">at</span><span class="o">.</span><span class="n">month</span><span class="o">]</span><span class="p">)</span>
      <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;game[at(3i)]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">at</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
      <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;game[at(4i)]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">at</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
      <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;game[at(5i)]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">at</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>

      <span class="n">updated_year</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">at</span><span class="o">.</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span>

      <span class="n">page</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">updated_year</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s2">&quot;game[at(1i)]&quot;</span><span class="p">)</span>

      <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Update Game&#39;</span><span class="p">)</span>

      <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">game_path</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

      <span class="n">updated_game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">find_by_location</span><span class="p">(</span><span class="n">unique_location</span><span class="p">)</span>

      <span class="n">updated_game</span><span class="o">.</span><span class="n">at</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">updated_year</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">&#39;should edit a game and return then to the edit page with their edited input when incorrect parameters are provided&#39;</span>

<span class="k">end</span>
</pre></div>

<p>To get this test passing we&#39;ll need an edit link <code>&lt;td&gt;&lt;%= link_to &#39;edit&#39;, edit_game_path(game) %&gt;&lt;/td&gt;</code> to the index page <code>app/views/games/index.html.erb</code></p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Games</span><span class="c1">#index&lt;/h1&gt;</span>

<span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="no">Game</span> <span class="n">I</span> <span class="n">have</span> <span class="n">created</span><span class="o">&lt;</span><span class="sr">/h2&gt;</span>
<span class="sr">&lt;table id=&quot;owned_games&quot;&gt;</span>
<span class="sr">    &lt;% @owned_games.each do |game| %&gt;</span>
<span class="sr">    &lt;tr data-row=&#39;game_&lt;%= game.id %&gt;&#39;&gt;</span>
<span class="sr">        &lt;td&gt;&lt;%= game.sport.name %&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="sx">%= game.location %&gt;&lt;/td&gt;</span>
<span class="sx">        &lt;td&gt;&lt;%=</span> <span class="n">game</span><span class="o">.</span><span class="n">at</span> <span class="sx">%&gt;&lt;/td&gt;</span>
        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="sx">%= link_to &#39;edit&#39;, edit_game_path(game) %&gt;&lt;/td&gt;</span>
<span class="sx">    &lt;/tr&gt;</span>
<span class="sx">    &lt;% end %&gt;</span>
<span class="sx">&lt;/table&gt;</span>

<span class="sx">&lt;h2&gt;Game I am playing&lt;/h2&gt;</span>
<span class="sx">&lt;table id=</span><span class="s2">&quot;games&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">% @games.each </span><span class="k">do</span> <span class="o">|</span><span class="n">game</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;tr data-row=&#39;game_&lt;%= game.id %&gt;</span><span class="s1">&#39;&gt;</span>
<span class="s1">        &lt;td&gt;&lt;%= game.sport.name %&gt;&lt;/td&gt;</span>
<span class="s1">        &lt;td&gt;&lt;%= game.location %&gt;&lt;/td&gt;</span>
<span class="s1">        &lt;td&gt;&lt;%= game.at %&gt;&lt;/td&gt;</span>
<span class="s1">    &lt;/tr&gt;</span>
<span class="s1">    &lt;% end %&gt;</span>
<span class="s1">&lt;/table&gt;</span>

<span class="s1">&lt;%= link_to &#39;</span><span class="no">Create</span> <span class="no">Game</span><span class="s1">&#39;, new_game_path, :class =&gt; &#39;</span><span class="n">btn</span> <span class="n">btn</span><span class="o">-</span><span class="n">primary</span><span class="err">&#39;</span> <span class="o">%&gt;</span>
</pre></div>

<p>We&#39;ll also need to include our form partial in the <code>app/views/games/edit.html.erb</code> page</p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Games</span><span class="c1">#edit&lt;/h1&gt;</span>
<span class="o">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;form&#39;</span> <span class="o">%&gt;</span>
</pre></div>

<p>and we&#39;ll need to find our game based on the id parameter passed in our <code>link_to &#39;edit&#39;, edit_game_path(game)</code> above. In our <code>app/controllers/games_controller.rb</code> update the edit method.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">edit</span>
  <span class="vi">@game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>then we&#39;ll need to add code to the update action of our games_controller</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">update</span>
   <span class="vi">@game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
   <span class="vi">@game</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:game</span><span class="o">]</span><span class="p">)</span>
   <span class="n">redirect</span><span class="p">\</span><span class="n">_to</span> <span class="n">game</span><span class="p">\</span><span class="n">_path</span><span class="p">(</span><span class="vi">@game</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>The test should now pass:</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<h3>8.6.2. it &#39;should not update an invalid game and display the edit page with the invalid data&#39;</h3>

<p>In this test we need to create a game, make some changes so that it&#39;s invalid and make sure those changes appear on the edit page that is returned to us when we submit the form.</p>

<ol>
<li>Create a game with a unique location Guid.</li>
<li>Visit the index page</li>
<li>Click the edit link for our game</li>
<li>Set the sport to the first empty option</li>
<li>Change the location</li>
<li>Update the Game</li>
<li>Ensure that the empty sport and the changed location are on the form that&#39;s returned.</li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should not update an invalid game and display the edit page with the invalid data&#39;</span> <span class="k">do</span>

    <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>

    <span class="n">visit</span> <span class="n">games_path</span>

    <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">page</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sport&quot;</span><span class="p">)</span> <span class="c1">#ensure the update fails</span>
    <span class="n">page</span><span class="o">.</span><span class="n">fill_in</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;Updated location&quot;</span><span class="p">)</span>

    <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Update Game&#39;</span><span class="p">)</span>

    <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">edit_game_path</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

    <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;Sport&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find_field</span><span class="p">(</span><span class="s1">&#39;Location&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">&quot;Updated location&quot;</span><span class="p">)</span>

<span class="k">end</span>
</pre></div>

<p>To get this test passing we&#39;ll need to amend the code in our <code>def update</code> action in the <code>app/controllers/games_controller.rb</code> </p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">update</span>
   <span class="vi">@game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
   <span class="k">if</span> <span class="vi">@game</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:game</span><span class="o">]</span><span class="p">)</span>
     <span class="n">redirect</span><span class="p">\</span><span class="n">_to</span> <span class="n">game</span><span class="p">\</span><span class="n">_path</span><span class="p">(</span><span class="vi">@game</span><span class="p">)</span>
   <span class="k">else</span>
     <span class="n">render</span> <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s1">&#39;games/edit.html.erb&#39;</span>
   <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h3>8.6.3. Updating players</h3>

<p>We want to be able to change the players in our game. The two conditions we should check for are an update that adds and removes players plus an update that removes all players. We need this second test to be sure we&#39;ve overcome a typical HTML &#39;gotcha&#39;, when all of the checkboxes in a checkbox array are unticked then browser doesn&#39;t submit any data for the array at all so instead of clearing the players nothing happens.</p>

<h3>8.6.4. it &#39;should update the games players&#39;</h3>

<p>We want to be able to change the players in our game. </p>

<p>Our test will</p>

<ol>
<li>Create two games, four players and add two players to each. We create two separate games so that our signed-in user is connected to four players but only two are selected in game1. If we had just one game then all four players would have to be selected. </li>
<li>Add the signed-in user to each so that the user is connected to all of the players</li>
<li>Navigate to the index page and click the edit link for game1</li>
<li>Ensure the two players that we added to the game are shown as checked</li>
<li>Ensure the two players we added to the other game are not checked</li>
<li>Uncheck the players in the game - our signed-in user and the two players we added</li>
<li>Check the two players we didn&#39;t add</li>
<li>Submit the form</li>
<li>Reload the association so that any changes are reflected</li>
<li>Check that the game now only has the two users we checked as players</li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should update the games players&#39;</span> <span class="k">do</span>
    <span class="n">game1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
    <span class="n">game2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>

    <span class="n">player1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">player2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">player3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">player4</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

    <span class="n">game1</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>
    <span class="n">game1</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player1</span>
    <span class="n">game1</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player2</span>

    <span class="n">game2</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>
    <span class="n">game2</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player3</span>
    <span class="n">game2</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player4</span>

    <span class="n">visit</span> <span class="n">games_path</span>

    <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player2</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_checked</span>

    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player2</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">check</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">check</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Update Game&#39;</span><span class="p">)</span>

    <span class="n">game1</span><span class="o">.</span><span class="n">players</span><span class="o">.</span><span class="n">reload</span>
    <span class="n">game1</span><span class="o">.</span><span class="n">players</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="o">[</span><span class="n">player3</span><span class="p">,</span> <span class="n">player4</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>

<p>This should all work out of the box</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<h3>8.6.5. it &#39;should update the games external players&#39;</h3>

<p>This test is very similar to our previous test. We want to be able to change the external players in our game. </p>

<p>Our test will</p>

<ol>
<li>Create two games, four external players and add two players to each.</li>
<li>Add the signed-in user to each so that the user is connected to all of the players</li>
<li>Navigate to the index page and click the edit link for game1</li>
<li>Ensure the two players that we added to the game are shown as checked</li>
<li>Ensure the two players we added to the other game are not checked</li>
<li>Uncheck the players in the game - our signed-in user and the two players we added</li>
<li>Check the two players we didn&#39;t add</li>
<li>Submit the form</li>
<li>Reload the association so that any changes are reflected</li>
<li>Check that the game now only has the two users we checked as players</li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should update the games external players&#39;</span> <span class="k">do</span>

    <span class="n">game1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
    <span class="n">game2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>

    <span class="n">player1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>
    <span class="n">player2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>
    <span class="n">player3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>
    <span class="n">player4</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>

    <span class="n">game1</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>
    <span class="n">game1</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player1</span>
    <span class="n">game1</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player2</span>

    <span class="n">game2</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>
    <span class="n">game2</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player3</span>
    <span class="n">game2</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player4</span>

    <span class="n">visit</span> <span class="n">games_path</span>

    <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_external_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_external_player_id_</span><span class="si">#{</span><span class="n">player2</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_external_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_external_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_checked</span>

    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player2</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">check</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">check</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Update Game&#39;</span><span class="p">)</span>

    <span class="n">game1</span><span class="o">.</span><span class="n">external_players</span><span class="o">.</span><span class="n">reload</span>
    <span class="n">game1</span><span class="o">.</span><span class="n">external_players</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="o">[</span><span class="n">player3</span><span class="p">,</span> <span class="n">player4</span><span class="o">]</span>

<span class="k">end</span>
</pre></div>

<p>This should all work out of the box</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<h3>8.6.6. it &#39;should remove all of the games players&#39;</h3>

<p>As we mentioned before a classic HTML gotcha is when all checkboxes are unchecked and no data is sent to the server so let&#39;s test for that.</p>

<ol>
<li>Create a game and four players</li>
<li>Add the sig-in user and the four players to the game</li>
<li>Navigate to the index page and click the edit link for the game</li>
<li>Ensure all four players and the sign-in user is checked</li>
<li>Uncheck all four players and the signed-in user</li>
<li>Submit the form</li>
<li>Reload the association and check that there are no players </li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should remove all of the games players&#39;</span> <span class="k">do</span>

    <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>

    <span class="n">player1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">player2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">player3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">player4</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

    <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>
    <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player1</span>
    <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player2</span>
    <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player3</span>
    <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="n">player4</span>

    <span class="n">visit</span> <span class="n">games_path</span>

    <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player2</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>

    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player2</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Update Game&#39;</span><span class="p">)</span>

    <span class="n">game</span><span class="o">.</span><span class="n">players</span><span class="o">.</span><span class="n">reload</span>
    <span class="n">game</span><span class="o">.</span><span class="n">players</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="o">[]</span>

<span class="k">end</span>
</pre></div>

<p>This test will fail. We have indeed fallen foul of the HTML gotcha because when we&#39;ve unchecked all the boxes no player_ids data is submitted and so the association just isn&#39;t updated. We can get around this by adding a hidden field with an empty value and the same name is the checkboxes. This will always be submitted and ensure that if all of the other players are unchecked the array player_ids =&gt; [&quot;&quot;] gets submitted with the request.</p>

<p>Add this hidden field <code>&lt;%= hidden_field_tag &quot;game[player_ids][]&quot; %&gt;</code> to our players control group in <code>app/views/games/_form.html.erb</code></p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;control-group &lt;%= &quot;</span><span class="n">error</span><span class="s2">&quot; if @game.errors.any? %&gt;&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">%= label_tag :players, nil, :class =</span><span class="o">&gt;</span> <span class="s1">&#39;control-label&#39;</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;div class=&#39;controls&#39; id=&quot;players&quot;&gt;</span>
        <span class="o">&lt;</span><span class="sx">% current_user.players.each </span><span class="k">do</span> <span class="o">|</span><span class="n">player</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">         &lt;%= check_box_tag &quot;game[player_ids][]&quot;, player.id, @game.players.include?(player), :id =&gt;</span> <span class="s2">&quot;game_player_id_</span><span class="si">#{</span><span class="n">player</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="sx">%&gt; &lt;%= player.email %&gt;</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
<span class="sx">        &lt;%= hidden_field_tag &quot;game[player_ids][]&quot; %&gt;</span>
    <span class="o">&lt;</span><span class="sr">/div&gt;</span>
<span class="sr">  &lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>

<p>The tests should now pass</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<h3>8.6.7. it &#39;should remove all of the games external players&#39;</h3>

<p>Again this test is very similar to our previous test and checks for the classic HTML gotcha when all checkboxes are unchecked and no data is sent to the server.</p>

<ol>
<li>Create a game and four external players</li>
<li>Add the sig-in user and the four external players to the game</li>
<li>Navigate to the index page and click the edit link for the game</li>
<li>Ensure all four external players and the sign-in user is checked</li>
<li>Uncheck all four external players and the signed-in user</li>
<li>Submit the form</li>
<li>Reload the association and check that there are no external players </li>
</ol>
<div class="highlight"><pre><span class="n">it</span> <span class="s1">&#39;should remove all of the games external players&#39;</span> <span class="k">do</span>

    <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>

    <span class="n">player1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>
    <span class="n">player2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>
    <span class="n">player3</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>
    <span class="n">player4</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>

    <span class="n">game</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="vi">@user</span>
    <span class="n">game</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player1</span>
    <span class="n">game</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player2</span>
    <span class="n">game</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player3</span>
    <span class="n">game</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="n">player4</span>

    <span class="n">visit</span> <span class="n">games_path</span>

    <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_external_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_external_player_id_</span><span class="si">#{</span><span class="n">player2</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_external_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>
    <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;input#game_external_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_checked</span>

    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player2</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player3</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">uncheck</span><span class="p">(</span><span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">player4</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Update Game&#39;</span><span class="p">)</span>

    <span class="n">game</span><span class="o">.</span><span class="n">external_players</span><span class="o">.</span><span class="n">reload</span>
    <span class="n">game</span><span class="o">.</span><span class="n">external_players</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="o">[]</span>

<span class="k">end</span>
</pre></div>

<p>This test will fail. Again we&#39;ve fallen foul of the HTML gotcha because when we&#39;ve unchecked all the boxes no external_player_ids are submitted and so the association just isn&#39;t updated. We get around this by adding a hidden field with an empty value and the same name as the checkboxes. This will always be submitted and ensure that if all of the other players are unchecked the array player_ids =&gt; [&quot;&quot;] gets submitted with the request.</p>

<p>Add this hidden field <code>&lt;%= hidden_field_tag &quot;game[external_player_ids][]&quot; %&gt;</code> to our external players control group in <code>app/views/games/_form.html.erb</code></p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;control-group &lt;%= &quot;</span><span class="n">error</span><span class="s2">&quot; if @game.errors.any? %&gt;&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">%= label_tag :players_not_on_stinky_trainers, nil, :class =</span><span class="o">&gt;</span> <span class="s1">&#39;control-label&#39;</span> <span class="sx">%&gt;</span>
<span class="sx">    &lt;div class=&#39;controls&#39; id=&quot;external_players&quot;&gt;</span>
        <span class="o">&lt;</span><span class="sx">% current_user.external_players.each </span><span class="k">do</span> <span class="o">|</span><span class="n">external_player</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">            &lt;%= check_box_tag &quot;game[external_player_ids][]&quot;, external_player.id, @game.external_players.include?(external_player), :id =&gt;</span> <span class="s2">&quot;game_external_player_id_</span><span class="si">#{</span><span class="n">external_player</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="sx">%&gt; &lt;%= external_player.email %&gt;</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
<span class="sx">        &lt;%= hidden_field_tag &quot;game[external_player_ids][]&quot; %&gt;</span>
    <span class="o">&lt;</span><span class="sr">/div&gt;</span>
<span class="sr">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>

<p>The tests should now pass</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p><a href="#top">back to top</a></p>

<h2><a id='testing-the-show-action'></a> 8.7. Testing the show action</h2>

<p>We want our show page to display all of the details we added in our create and update pages.</p>

<ol>
<li>Create two games and add players to one of the games</li>
<li>Navigate to the games index page</li>
<li>Navigate to one of the two games show page</li>
<li>Ensure the correct content is present.</li>
</ol>
<div class="highlight"><pre><span class="n">describe</span> <span class="s1">&#39;showing games&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should allow users to view a game&#39;</span> <span class="k">do</span>

      <span class="n">game1</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
      <span class="n">game2</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>

      <span class="n">game2</span><span class="o">.</span><span class="n">players</span> <span class="o">&lt;&lt;</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="n">game2</span><span class="o">.</span><span class="n">external_players</span> <span class="o">&lt;&lt;</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:external_player</span><span class="p">)</span>

      <span class="n">visit</span> <span class="n">games_path</span>

      <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game2</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
          <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">game_path</span><span class="p">(</span><span class="n">game2</span><span class="p">)</span>

      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game2</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game2</span><span class="o">.</span><span class="n">at</span><span class="p">)</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game2</span><span class="o">.</span><span class="n">sport</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="n">within</span><span class="p">(</span><span class="s2">&quot;ul#players&quot;</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game2</span><span class="o">.</span><span class="n">players</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game2</span><span class="o">.</span><span class="n">players</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">within</span><span class="p">(</span><span class="s2">&quot;ul#external_players&quot;</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game2</span><span class="o">.</span><span class="n">external_players</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">game2</span><span class="o">.</span><span class="n">external_players</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
      <span class="k">end</span>

    <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Run the test and see what fails first.</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>

<span class="go">1) games showing games should allow users to view a game</span>
<span class="go">   Failure/Error: click_link(&#39;show&#39;)</span>
<span class="go">   Capybara::ElementNotFound:</span>
<span class="go">     no link with title, id or text &#39;show&#39; found</span>
<span class="go">   # (eval):2:in `click_link&#39;</span>
<span class="go">   # ./spec/integration/games/restful_spec.rb:573:in `block (4 levels) in &lt;top (required)&gt;&#39;</span>
<span class="go">   # ./spec/integration/games/restful_spec.rb:572:in `block (3 levels) in &lt;top (required)&gt;&#39;</span>
</pre></div>

<p>We need to add a &#39;show&#39; link to the index page. Add <code>&lt;td&gt;&lt;%= link_to &#39;show&#39;, game_path(game) %&gt;&lt;/td&gt;</code> to <code>app/views/games/index.html.erb</code></p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="no">Game</span> <span class="n">I</span> <span class="n">have</span> <span class="n">created</span><span class="o">&lt;</span><span class="sr">/h2&gt;</span>
<span class="sr">&lt;table id=&quot;owned_games&quot;&gt;</span>
<span class="sr">    &lt;% @owned_games.each do |game| %&gt;</span>
<span class="sr">    &lt;tr data-row=&#39;game_&lt;%= game.id %&gt;&#39;&gt;</span>
<span class="sr">        &lt;td&gt;&lt;%= game.sport.name %&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="sx">%= game.location %&gt;&lt;/td&gt;</span>
<span class="sx">        &lt;td&gt;&lt;%=</span> <span class="n">game</span><span class="o">.</span><span class="n">at</span> <span class="sx">%&gt;&lt;/td&gt;</span>
        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="sx">%= link\_to &#39;edit&#39;, edit\_game_path(game) %&gt;&lt;/td&gt;</span>
<span class="sx">        &lt;td&gt;&lt;%=</span> <span class="n">link</span><span class="p">\</span><span class="n">_to</span> <span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="n">game</span><span class="p">\</span><span class="n">_path</span><span class="p">(</span><span class="n">game</span><span class="p">)</span> <span class="sx">%&gt;&lt;/td&gt;</span>
    <span class="o">&lt;</span><span class="sr">/tr&gt;</span>
<span class="sr">    &lt;% end %&gt;</span>
<span class="sr">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
</pre></div>

<p>Run the test and see what fails next.</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>

<span class="go">Failures:</span>

<span class="go">  1) games showing games should allow users to view a game</span>
<span class="go">     Failure/Error: page.should have_content(game2.location)</span>
<span class="go">       expected there to be content &quot;location26&quot; in &quot;StinkyTrainers\n    \n    \n      \n        \n          \n            \n            \n            \n          \n\n          Stinkytrainers\n          \n            dashboard\n                games\n                sports\n\t   \t\t    sign-out\n            Ruby On Rails Tutorial\n\n            \n        \n      \n\t  \n\t\n    \n\t\n    \n\t\n    \n      \n        \n           \n\t\t\t\n\t\t\t\tGames#show\n\n\n\n\t\t\t\n            \n            \n\t\t\t\t \n            \n        \n      \n\n      © Stinky Trainers 2012\n       \n\n    \n    \n    &quot;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:578:in `block (3 levels) in &lt;top (required)&gt;&#39;</span>
</pre></div>

<p>Ok we need to code our show page so add this to <code>app/views/games/show.html.erb</code></p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Games</span><span class="c1">#show&lt;/h1&gt;</span>

<span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;game&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;&lt;</span><span class="sx">%= @game.location %&gt;&lt;/p&gt;</span>
<span class="sx">    &lt;p&gt;&lt;%=</span> <span class="vi">@game</span><span class="o">.</span><span class="n">at</span> <span class="sx">%&gt;&lt;/p&gt;</span>
    <span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;&lt;</span><span class="sx">%= @game.sport.name %&gt;&lt;/p&gt;</span>
<span class="sx">&lt;/div&gt;</span>

<span class="sx">&lt;h2&gt;Players&lt;/h2&gt;</span>
<span class="sx">&lt;ul id=</span><span class="s2">&quot;players&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">% @game.players.each </span><span class="k">do</span> <span class="o">|</span><span class="n">player</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">        &lt;%= player.email %&gt;</span>
    <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
<span class="sx">&lt;/ul&gt;</span>

<span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="no">Players</span> <span class="n">outside</span> <span class="no">Stinky</span> <span class="no">Trainers</span><span class="o">&lt;</span><span class="sr">/h2&gt;</span>
<span class="sr">&lt;ul id=&quot;external_players&quot;&gt;</span>
<span class="sr">    &lt;% @game.external_players.each do |player| %&gt;</span>
<span class="sr">        &lt;%= player.email %&gt;</span>
<span class="sr">    &lt;% end %&gt;</span>
<span class="sr">&lt;/u</span><span class="n">l</span><span class="o">&gt;</span>
</pre></div>

<p>Run the tests again and suddenly we&#39;ve got 9 failing...</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>

<span class="go">Failures:</span>

<span class="go">  1) games showing games should allow users to view a game</span>
<span class="go">     Failure/Error: click_link(&#39;show&#39;)</span>
<span class="go">     ActionView::Template::Error:</span>
<span class="go">       undefined method `location&#39; for nil:NilClass</span>
<span class="go">     # ./app/views/games/show.html.erb:4:in `_app_views_games_show_html_erb___3654771997461038398_70359103604200&#39;</span>
<span class="go">     # (eval):2:in `click_link&#39;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:573:in `block (4 levels) in &lt;top (required)&gt;&#39;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:572:in `block (3 levels) in &lt;top (required)&gt;&#39;</span>

<span class="go">  2) games editing games should update a valid game and redirect to the show page</span>
<span class="go">     Failure/Error: click_button(&#39;Update Game&#39;)</span>
<span class="go">     ActionView::Template::Error:</span>
<span class="go">       undefined method `location&#39; for nil:NilClass</span>
<span class="go">     # ./app/views/games/show.html.erb:4:in `_app_views_games_show_html_erb___3654771997461038398_70359103604200&#39;</span>
<span class="go">     # (eval):2:in `click_button&#39;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:365:in `block (3 levels) in &lt;top (required)&gt;&#39;</span>

<span class="go">  3) games editing games updating players should update the games players</span>
<span class="go">     Failure/Error: click_button(&#39;Update Game&#39;)</span>
<span class="go">     ActionView::Template::Error:</span>
<span class="go">       undefined method `location&#39; for nil:NilClass</span>
<span class="go">     # ./app/views/games/show.html.erb:4:in `_app_views_games_show_html_erb___3654771997461038398_70359103604200&#39;</span>
<span class="go">     # (eval):2:in `click_button&#39;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:432:in `block (4 levels) in &lt;top (required)&gt;&#39;</span>

<span class="go">  4) games editing games updating players should update the games external players</span>
<span class="go">     Failure/Error: click_button(&#39;Update Game&#39;)</span>
<span class="go">     ActionView::Template::Error:</span>
<span class="go">       undefined method `location&#39; for nil:NilClass</span>
<span class="go">     # ./app/views/games/show.html.erb:4:in `_app_views_games_show_html_erb___3654771997461038398_70359103604200&#39;</span>
<span class="go">     # (eval):2:in `click_button&#39;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:472:in `block (4 levels) in &lt;top (required)&gt;&#39;</span>

<span class="go">  5) games editing games updating players should remove all of the games players</span>
<span class="go">     Failure/Error: click_button(&#39;Update Game&#39;)</span>
<span class="go">     ActionView::Template::Error:</span>
<span class="go">       undefined method `location&#39; for nil:NilClass</span>
<span class="go">     # ./app/views/games/show.html.erb:4:in `_app_views_games_show_html_erb___3654771997461038398_70359103604200&#39;</span>
<span class="go">     # (eval):2:in `click_button&#39;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:512:in `block (4 levels) in &lt;top (required)&gt;&#39;</span>

<span class="go">  6) games editing games updating players should remove all of the games external players</span>
<span class="go">     Failure/Error: click_button(&#39;Update Game&#39;)</span>
<span class="go">     ActionView::Template::Error:</span>
<span class="go">       undefined method `location&#39; for nil:NilClass</span>
<span class="go">     # ./app/views/games/show.html.erb:4:in `_app_views_games_show_html_erb___3654771997461038398_70359103604200&#39;</span>
<span class="go">     # (eval):2:in `click_button&#39;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:550:in `block (4 levels) in &lt;top (required)&gt;&#39;</span>

<span class="go">  7) games creating games should create a new game when valid game parameters are provided and redirect to the show page</span>
<span class="go">     Failure/Error: click_button(&#39;Create Game&#39;)</span>
<span class="go">     ActionView::Template::Error:</span>
<span class="go">       undefined method `location&#39; for nil:NilClass</span>
<span class="go">     # ./app/views/games/show.html.erb:4:in `_app_views_games_show_html_erb___3654771997461038398_70359103604200&#39;</span>
<span class="go">     # (eval):2:in `click_button&#39;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:112:in `block (4 levels) in &lt;top (required)&gt;&#39;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:111:in `block (3 levels) in &lt;top (required)&gt;&#39;</span>

<span class="go">  8) games creating games adding players should submit a list of the selected players and add them to the game</span>
<span class="go">     Failure/Error: click_button(&#39;Create Game&#39;)</span>
<span class="go">     ActionView::Template::Error:</span>
<span class="go">       undefined method `location&#39; for nil:NilClass</span>
<span class="go">     # ./app/views/games/show.html.erb:4:in `_app_views_games_show_html_erb___3654771997461038398_70359103604200&#39;</span>
<span class="go">     # (eval):2:in `click_button&#39;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:277:in `block (4 levels) in &lt;top (required)&gt;&#39;</span>

<span class="go">  9) games creating games adding players should submit a list of the selected external players and add them to the game</span>
<span class="go">     Failure/Error: click_button(&#39;Create Game&#39;)</span>
<span class="go">     ActionView::Template::Error:</span>
<span class="go">       undefined method `location&#39; for nil:NilClass</span>
<span class="go">     # ./app/views/games/show.html.erb:4:in `_app_views_games_show_html_erb___3654771997461038398_70359103604200&#39;</span>
<span class="go">     # (eval):2:in `click_button&#39;</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:322:in `block (4 levels) in &lt;top (required)&gt;&#39;</span>
</pre></div>

<p>Don&#39;t panic; all of these tests use the show page at some point. We&#39;ve coded the page itself so the view is trying to call things like <code>@game.location</code> but we haven&#39;t added code the to controller to populate the <code>@game</code> variable. Just add this code to <code>def show</code> action of <code>app/controllers/ga,es_controller.rb</code> </p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">show</span>
 <span class="vi">@game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>and the tests should all now pass</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>
</pre></div>

<p><a href="#top">back to top</a></p>

<h2><a id='testing-the-destroy-action'></a> 8.8. Testing the destroy action</h2>

<p>To be sure that uses don&#39;t accidentally destroy the wrong game we&#39;ll have the destroy link in the show page. So our test must </p>

<ol>
<li>Create a game</li>
<li>Navigate to the game&#39;s show page.</li>
<li>Click the destroy link</li>
<li>Ensure game count is changed by -1</li>
<li>Ensure we&#39;re redirected back to the games index page</li>
<li>Ensure the game is no longer there.</li>
</ol>
<div class="highlight"><pre><span class="n">describe</span> <span class="s1">&#39;destroying games&#39;</span> <span class="k">do</span>
   <span class="n">it</span> <span class="s1">&#39;should allow users to destroy a game and redirect them back to the index page&#39;</span> <span class="k">do</span>

     <span class="n">game</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>

     <span class="n">visit</span> <span class="n">games_path</span>

     <span class="n">within</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span> <span class="k">do</span>
          <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">)</span>
     <span class="k">end</span>

     <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">game_path</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

     <span class="n">expect</span><span class="p">{</span> 
       <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;Destroy&#39;</span><span class="p">)</span>
     <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">{</span><span class="no">Game</span><span class="o">.</span><span class="n">count</span><span class="p">}</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

     <span class="n">page</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">games_path</span>

     <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">&quot;tr[@data-row=&#39;game_</span><span class="si">#{</span><span class="n">game</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span>

   <span class="k">end</span>
 <span class="k">end</span>
</pre></div>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>

<span class="go">Failures:</span>

<span class="go">  1) games destroying games should allow users to destroy a game and redirect them back to the index page</span>
<span class="go">     Failure/Error: click_link(&#39;Destroy&#39;)</span>
<span class="go">     Capybara::ElementNotFound:</span>
<span class="go">       no link with title, id or text &#39;Destroy&#39; found</span>
</pre></div>

<p>We don&#39;t have a destroy link on our show page so add <code>&lt;div&gt;&lt;%= link_to &#39;Destroy&#39;, game_path(@game), method: :delete, data: { confirm: &#39;Are you sure?&#39; }, :class =&gt; &#39;btn btn-danger btn-mini&#39; %&gt;&lt;/div&gt;</code> to the bottom of <code>app/views/games/show.html.erb</code>.</p>
<div class="highlight"><pre><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Games</span><span class="c1">#show&lt;/h1&gt;</span>

<span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;game&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;&lt;</span><span class="sx">%= @game.location %&gt;&lt;/p&gt;</span>
<span class="sx">    &lt;p&gt;&lt;%=</span> <span class="vi">@game</span><span class="o">.</span><span class="n">at</span> <span class="sx">%&gt;&lt;/p&gt;</span>
    <span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;&lt;</span><span class="sx">%= @game.sport.name %&gt;&lt;/p&gt;</span>
<span class="sx">&lt;/div&gt;</span>

<span class="sx">&lt;h2&gt;Players&lt;/h2&gt;</span>
<span class="sx">&lt;ul id=</span><span class="s2">&quot;players&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">% @game.players.each </span><span class="k">do</span> <span class="o">|</span><span class="n">player</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">        &lt;li&gt;</span><span class="o">&lt;</span><span class="sx">%= player.email %&gt;&lt;/li&gt;</span>
<span class="sx">    &lt;% end %&gt;</span>
<span class="sx">&lt;/ul&gt;</span>

<span class="sx">&lt;h2&gt;Players outside Stinky Trainers&lt;/h2&gt;</span>
<span class="sx">&lt;ul id=</span><span class="s2">&quot;external_players&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">% @game.external_players.each </span><span class="k">do</span> <span class="o">|</span><span class="n">player</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">        &lt;li&gt;</span><span class="o">&lt;</span><span class="sx">%= player.email %&gt;&lt;/li&gt;</span>
<span class="sx">    &lt;% end %&gt;</span>
<span class="sx">&lt;/ul&gt;</span>

<span class="sx">&lt;div&gt;&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Destroy&#39;</span><span class="p">,</span> <span class="n">game_path</span><span class="p">(</span><span class="vi">@game</span><span class="p">),</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="p">{</span> <span class="n">confirm</span><span class="p">:</span> <span class="s1">&#39;Are you sure?&#39;</span> <span class="p">},</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s1">&#39;btn btn-danger btn-mini&#39;</span> <span class="sx">%&gt;&lt;/div&gt;</span>
</pre></div>

<p>Run the tests again</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>

<span class="go">Failures:</span>

<span class="go">  1) games destroying games should allow users to destroy a game and redirect them back to the index page</span>
<span class="go">     Failure/Error: expect{</span>
<span class="go">       result should have been changed by -1, but was changed by 0</span>
<span class="go">     # ./spec/integration/games/restful_spec.rb:608:in `block (3 levels) in &lt;top (required)&gt;&#39;</span>
</pre></div>

<p>Our game count hasn&#39;t reduced even though we&#39;ve clicked on &quot;Destroy&quot;. Well, we haven&#39;t added the destroy code to our controller. Add the lines below to <code>def destroy</code> of <code>app/controllers/games_controller.rb</code></p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">destroy</span>
  <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="n">game</span><span class="o">.</span><span class="n">destroy</span>
<span class="k">end</span>
</pre></div>

<p>Run the tests again</p>
<div class="highlight"><pre><span class="go">bundle exec rake spec</span>

<span class="go">Failures:</span>

<span class="go">  1) games destroying games should allow users to destroy a game and redirect them back to the index page</span>
<span class="go">     Failure/Error: page.current_path.should == games_path</span>
<span class="go">       expected: &quot;/games&quot;</span>
<span class="go">            got: &quot;/games/1&quot; (using ==)</span>
</pre></div>

<p>We&#39;re not redirecting to the index page when the game is destroyed so add the line <code>redirect_to games_path</code> to <code>def destroy</code> in our controller</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">destroy</span>
  <span class="n">game</span> <span class="o">=</span> <span class="no">Game</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="n">game</span><span class="o">.</span><span class="n">destroy</span>
  <span class="n">redirect</span><span class="p">\</span><span class="n">_to</span> <span class="n">games</span><span class="p">\</span><span class="n">_path</span>
<span class="k">end</span>
</pre></div>

<p>and everything should pass.</p>
